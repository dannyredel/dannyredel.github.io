<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Honest Inference for Event Study Plots – Daniel Redel</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../myprofile.jpg" rel="icon" type="image/jpeg">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-3ad3898019ac633b5dc008510ac09064.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-76702eb7cada84b330ed18131569fa4c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Daniel Redel</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../myposts.html"> <i class="bi bi-pencil-square" role="img">
</i> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> <i class="bi bi-folder" role="img">
</i> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html"> <i class="bi bi-journal-text" role="img">
</i> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> <i class="bi bi-person" role="img">
</i> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dannyredel"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/daniel-redel-14b052b6/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/DannyRedel"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Honest Inference for Event Study Plots</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Goal</strong>: Assess and prototype honest inference features for <code>diff-diff</code> plotting, inspired by:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Package</th>
<th>Approach</th>
<th>Key Innovation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://github.com/asheshrambachan/HonestDiD">HonestDiD</a></td>
<td>Sensitivity analysis</td>
<td>CIs robust to parallel trends violations</td>
</tr>
<tr class="even">
<td><a href="https://github.com/JMSLab/eventstudyr">eventstudyr</a></td>
<td>Simultaneous inference</td>
<td>Sup-t bands + smoothest confounding path</td>
</tr>
<tr class="odd">
<td><a href="https://ccfang2.github.io/fdid/">fdid</a></td>
<td>Functional DiD</td>
<td>SCBs for equivalence/relevance testing</td>
</tr>
</tbody>
</table>
<p><strong>Key papers</strong>: - Rambachan &amp; Roth (2023) — “A More Credible Approach to Parallel Trends” - Freyaldenhoven, Hansen, Perez Perez, Shapiro (2021) — “Visualization, Identification, and Estimation in the Linear Panel Event-Study Design” (NBER w29170) - Roth (2026) — “Interpreting Event-Studies from Recent Difference-in-Differences Methods” - Fang &amp; Liebl (2026) — “Functional Difference-in-Differences” (fdid)</p>
<hr>
<section id="table-of-contents1.-setup-data2.-what-diff-diff-already-has-honestdid3.-gap-1-simultaneous-confidence-bands-eventstudyr4.-gap-2-smoothest-confounding-path-eventstudyr5.-gap-3-functional-scbs-fdid6.-insights-from-the-papers7.-compatibility-assessment8.-prototypes9.-multi-model-comparison-fairness10.-freyaldenhoven-et-al.-plot-features11.-comprehensive-roadmap" class="level2">
<h2 class="anchored" data-anchor-id="table-of-contents1.-setup-data2.-what-diff-diff-already-has-honestdid3.-gap-1-simultaneous-confidence-bands-eventstudyr4.-gap-2-smoothest-confounding-path-eventstudyr5.-gap-3-functional-scbs-fdid6.-insights-from-the-papers7.-compatibility-assessment8.-prototypes9.-multi-model-comparison-fairness10.-freyaldenhoven-et-al.-plot-features11.-comprehensive-roadmap">Table of Contents1. <a href="#1-setup--data">Setup &amp; Data</a>2. <a href="#2-what-diff-diff-already-has-honestdid">What <code>diff-diff</code> Already Has: HonestDiD</a>3. <a href="#3-gap-1-simultaneous-confidence-bands">Gap 1: Simultaneous Confidence Bands (eventstudyr)</a>4. <a href="#4-gap-2-smoothest-confounding-path">Gap 2: Smoothest Confounding Path (eventstudyr)</a>5. <a href="#5-gap-3-functional-scbs">Gap 3: Functional SCBs (fdid)</a>6. <a href="#6-insights-from-the-papers">Insights from the Papers</a>7. <a href="#7-compatibility-assessment">Compatibility Assessment</a>8. <a href="#8-prototypes">Prototypes</a>9. <a href="#9-multi-model-comparison-fairness">Multi-Model Comparison Fairness</a>10. <a href="#10-freyaldenhoven-et-al-plot-features">Freyaldenhoven et al.&nbsp;Plot Features</a>11. <a href="#11-comprehensive-roadmap">Comprehensive Roadmap</a></h2>
</section>
<section id="setup-data" class="level2">
<h2 class="anchored" data-anchor-id="setup-data">1. Setup &amp; Data</h2>
<div id="imports" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats <span class="im">as</span> scipy_stats</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize, linprog</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diff_diff <span class="im">import</span> (</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    MultiPeriodDiD,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    CallawaySantAnna,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    generate_did_data,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    load_mpdta,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    plot_event_study,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># HonestDiD from diff-diff</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diff_diff <span class="im">import</span> HonestDiD</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diff_diff.honest_did <span class="im">import</span> SensitivityResults, HonestDiDResults</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diff_diff.visualization <span class="im">import</span> plot_sensitivity, plot_honest_event_study</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'All imports successful'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\danny\anaconda3\Lib\site-packages\pandas\core\computation\expressions.py:22: UserWarning: Pandas requires version '2.10.2' or newer of 'numexpr' (version '2.8.7' currently installed).
  from pandas.core.computation.check import NUMEXPR_INSTALLED
c:\Users\danny\anaconda3\Lib\site-packages\pandas\core\arrays\masked.py:56: UserWarning: Pandas requires version '1.4.2' or newer of 'bottleneck' (version '1.3.7' currently installed).
  from pandas.core import (</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>All imports successful</code></pre>
</div>
</div>
<div id="data-setup" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate panel data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> generate_did_data(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    n_units<span class="op">=</span><span class="dv">200</span>, n_periods<span class="op">=</span><span class="dv">10</span>, treatment_effect<span class="op">=</span><span class="fl">5.0</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    treatment_fraction<span class="op">=</span><span class="fl">0.5</span>, treatment_period<span class="op">=</span><span class="dv">5</span>, seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Multi-period DiD</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>mp_did <span class="op">=</span> MultiPeriodDiD(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>mp_results <span class="op">=</span> mp_did.fit(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    data, outcome<span class="op">=</span><span class="st">'outcome'</span>, treatment<span class="op">=</span><span class="st">'treated'</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    time<span class="op">=</span><span class="st">'period'</span>, post_periods<span class="op">=</span><span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">5</span>, <span class="dv">10</span>)),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'ATT = </span><span class="sc">{</span>mp_results<span class="sc">.</span>avg_att<span class="sc">:.3f}</span><span class="ss"> (SE = </span><span class="sc">{</span>mp_results<span class="sc">.</span>avg_se<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Also prepare staggered data</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    mpdta <span class="op">=</span> load_mpdta()</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    cs <span class="op">=</span> CallawaySantAnna(control_group<span class="op">=</span><span class="st">'never_treated'</span>, alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    cs_results <span class="op">=</span> cs.fit(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        mpdta, outcome<span class="op">=</span><span class="st">'lemp'</span>, unit<span class="op">=</span><span class="st">'countyreal'</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        time<span class="op">=</span><span class="st">'year'</span>, first_treat<span class="op">=</span><span class="st">'first_treat'</span>, aggregate<span class="op">=</span><span class="st">'event_study'</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'CS Overall ATT = </span><span class="sc">{</span>cs_results<span class="sc">.</span>overall_att<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'CS failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    cs_results <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Synthetic event study data for plotting demos</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>true_effect <span class="op">=</span> np.where(periods <span class="op">&gt;=</span> <span class="dv">0</span>, <span class="fl">3.0</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> periods, <span class="dv">0</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="bu">len</span>(periods))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>estimates <span class="op">=</span> true_effect <span class="op">+</span> noise</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>se_vals <span class="op">=</span> np.<span class="bu">abs</span>(np.random.normal(<span class="fl">0.4</span>, <span class="fl">0.08</span>, <span class="bu">len</span>(periods)))</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Set reference period to 0</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>estimates[periods <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>se_vals[periods <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>es_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'period'</span>: periods,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'estimate'</span>: estimates,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'se'</span>: se_vals,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Synthetic ES data: </span><span class="sc">{</span><span class="bu">len</span>(es_df)<span class="sc">}</span><span class="ss"> periods'</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>es_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ATT = 4.977 (SE = 0.292)
CS Overall ATT = -0.0214
Synthetic ES data: 11 periods</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">period</th>
<th data-quarto-table-cell-role="th">estimate</th>
<th data-quarto-table-cell-role="th">se</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-5</td>
<td>0.149014</td>
<td>0.362742</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-4</td>
<td>-0.041479</td>
<td>0.419357</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-3</td>
<td>0.194307</td>
<td>0.246938</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-2</td>
<td>0.456909</td>
<td>0.262007</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-1</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0</td>
<td>2.929759</td>
<td>0.318974</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1</td>
<td>3.773764</td>
<td>0.425140</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2</td>
<td>3.830230</td>
<td>0.327358</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>3</td>
<td>3.759158</td>
<td>0.287016</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>4</td>
<td>4.362768</td>
<td>0.517252</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>5</td>
<td>4.360975</td>
<td>0.381938</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="what-diff-diff-already-has-honestdid" class="level2">
<h2 class="anchored" data-anchor-id="what-diff-diff-already-has-honestdid">2. What <code>diff-diff</code> Already Has: HonestDiD</h2>
<p><code>diff-diff</code> already implements the core of Rambachan &amp; Roth (2023):</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 29%">
<col style="width: 37%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>Status</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Smoothness restriction (<span class="math inline">\(\Delta^{SD}\)</span>)</td>
<td>Available</td>
<td><code>HonestDiD(method='smoothness')</code></td>
</tr>
<tr class="even">
<td>Relative magnitude (<span class="math inline">\(\Delta^{RM}\)</span>)</td>
<td>Available</td>
<td><code>HonestDiD(method='relative_magnitude')</code></td>
</tr>
<tr class="odd">
<td>Combined (<span class="math inline">\(\Delta^{SDRM}\)</span>)</td>
<td>Available</td>
<td><code>HonestDiD(method='combined')</code></td>
</tr>
<tr class="even">
<td>Sensitivity analysis</td>
<td>Available</td>
<td><code>HonestDiD.sensitivity_analysis()</code></td>
</tr>
<tr class="odd">
<td>Breakdown value</td>
<td>Available</td>
<td><code>HonestDiD.breakdown_value()</code></td>
</tr>
<tr class="even">
<td>Sensitivity plot</td>
<td>Available</td>
<td><code>plot_sensitivity()</code></td>
</tr>
<tr class="odd">
<td>Honest event study plot</td>
<td>Available</td>
<td><code>plot_honest_event_study()</code></td>
</tr>
</tbody>
</table>
<p>Let’s demo these existing functions.</p>
<div id="demo-honest-fit" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># HonestDiD with relative magnitude restriction</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>honest <span class="op">=</span> HonestDiD(method<span class="op">=</span><span class="st">'relative_magnitude'</span>, M<span class="op">=</span><span class="fl">1.0</span>, alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>honest_results <span class="op">=</span> honest.fit(mp_results)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'=== HonestDiD Results (Relative Magnitude, M=1.0) ==='</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>honest_results.print_summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== HonestDiD Results (Relative Magnitude, M=1.0) ===
======================================================================
               Honest DiD Sensitivity Analysis Results                
                       (Rambachan &amp; Roth 2023)                        
======================================================================

Method:                        Relative Magnitudes (Delta^RM)
Restriction parameter (M):     1.0000
CI method:                     C-LF

----------------------------------------------------------------------
              Original Estimate (under parallel trends)               
----------------------------------------------------------------------
Point estimate:                4.9771
Standard error:                0.2918

----------------------------------------------------------------------
               Robust Results (allowing for violations)               
----------------------------------------------------------------------
Identified set:                [4.7673, 5.1868]
95% Robust CI:                 [4.1955, 5.7587]

Effect robust to violations:   Yes

----------------------------------------------------------------------
                            Interpretation                            
----------------------------------------------------------------------
Post-treatment violations bounded at 1.0x max pre-period violation.
Effect remains POSITIVE even with violations up to M=1.0.

======================================================================</code></pre>
</div>
</div>
<div id="demo-sensitivity" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sensitivity analysis</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>sens_results <span class="op">=</span> honest.sensitivity_analysis(mp_results)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sens_results.print_summary()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Breakdown value</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>bd <span class="op">=</span> honest.breakdown_value(mp_results)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Breakdown value: </span><span class="sc">{</span>bd<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>======================================================================
                   Honest DiD Sensitivity Analysis                    
======================================================================

Method:                        relative_magnitude
Original estimate:             4.9771
Original SE:                   0.2918
M values tested:               9

Breakdown value:               None (always significant)

----------------------------------------------------------------------
M           Lower Bound  Upper Bound     CI Lower     CI Upper
----------------------------------------------------------------------
0.0000           4.9771       4.9771       4.4052       5.5489
0.2500           4.9246       5.0295       4.3528       5.6014
0.5000           4.8722       5.0820       4.3004       5.6538
0.7500           4.8198       5.1344       4.2479       5.7062
1.0000           4.7673       5.1868       4.1955       5.7587
1.2500           4.7149       5.2393       4.1431       5.8111
1.5000           4.6625       5.2917       4.0906       5.8635
1.7500           4.6100       5.3441       4.0382       5.9160
2.0000           4.5576       5.3966       3.9858       5.9684

======================================================================

Breakdown value: None</code></pre>
</div>
</div>
<div id="demo-existing-plots" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="fl">5.5</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Left: Sensitivity plot</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>plot_sensitivity(sens_results, ax<span class="op">=</span>axes[<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                 title<span class="op">=</span><span class="st">'Existing: plot_sensitivity()'</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Right: Honest event study</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>plot_honest_event_study(honest_results, ax<span class="op">=</span>axes[<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                        title<span class="op">=</span><span class="st">'Existing: plot_honest_event_study()'</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg ansi-bold">ValueError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg ansi-bold">In[5], line 8</span>
<span class="ansi-green-fg">      4</span> plot_sensitivity(sens_results, ax<span style="color:rgb(98,98,98)">=</span>axes[<span style="color:rgb(98,98,98)">0</span>], show<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg">      5</span>                  title<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Existing: plot_sensitivity()</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg">      7</span> <span style="font-style:italic;color:rgb(95,135,135)"># Right: Honest event study</span>
<span class="ansi-green-fg ansi-bold">----&gt; 8</span> plot_honest_event_study(honest_results, ax<span style="color:rgb(98,98,98)">=</span>axes[<span style="color:rgb(98,98,98)">1</span>], show<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg">      9</span>                         title<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Existing: plot_honest_event_study()</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg">     11</span> plt<span style="color:rgb(98,98,98)">.</span>tight_layout()
<span class="ansi-green-fg">     12</span> plt<span style="color:rgb(98,98,98)">.</span>show()

File <span class="ansi-green-fg ansi-bold">c:\Users\danny\anaconda3\Lib\site-packages\diff_diff\visualization.py:858</span>, in <span class="ansi-cyan-fg">plot_honest_event_study</span><span class="ansi-blue-fg ansi-bold">(honest_results, periods, reference_period, figsize, title, xlabel, ylabel, original_color, honest_color, marker, markersize, capsize, ax, show)</span>
<span class="ansi-green-fg">    853</span> <span style="font-style:italic;color:rgb(95,135,135)"># Plot honest CIs (thicker, foreground)</span>
<span class="ansi-green-fg">    854</span> yerr_honest <span style="color:rgb(98,98,98)">=</span> [
<span class="ansi-green-fg">    855</span>     [e <span style="color:rgb(98,98,98)">-</span> lower <span style="font-weight:bold;color:rgb(0,135,0)">for</span> e, lower <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(effects, honest_ci_lower)],
<span class="ansi-green-fg">    856</span>     [u <span style="color:rgb(98,98,98)">-</span> e <span style="font-weight:bold;color:rgb(0,135,0)">for</span> e, u <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">zip</span>(effects, honest_ci_upper)],
<span class="ansi-green-fg">    857</span> ]
<span class="ansi-green-fg ansi-bold">--&gt; 858</span> ax<span style="color:rgb(98,98,98)">.</span>errorbar(
<span class="ansi-green-fg">    859</span>     x_vals,
<span class="ansi-green-fg">    860</span>     effects,
<span class="ansi-green-fg">    861</span>     yerr<span style="color:rgb(98,98,98)">=</span>yerr_honest,
<span class="ansi-green-fg">    862</span>     fmt<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">none</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg">    863</span>     color<span style="color:rgb(98,98,98)">=</span>honest_color,
<span class="ansi-green-fg">    864</span>     capsize<span style="color:rgb(98,98,98)">=</span>capsize,
<span class="ansi-green-fg">    865</span>     linewidth<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">2</span>,
<span class="ansi-green-fg">    866</span>     label<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Honest CI (M=</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>honest_results<span style="color:rgb(98,98,98)">.</span>M<span style="font-weight:bold;color:rgb(175,95,135)">:</span><span style="color:rgb(175,0,0)">.2f</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">)</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg">    867</span> )
<span class="ansi-green-fg">    869</span> <span style="font-style:italic;color:rgb(95,135,135)"># Plot point estimates</span>
<span class="ansi-green-fg">    870</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> i, (x, effect, period) <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">enumerate</span>(<span style="color:rgb(0,135,0)">zip</span>(x_vals, effects, periods)):

File <span class="ansi-green-fg ansi-bold">c:\Users\danny\anaconda3\Lib\site-packages\matplotlib\__init__.py:1465</span>, in <span class="ansi-cyan-fg">_preprocess_data.&lt;locals&gt;.inner</span><span class="ansi-blue-fg ansi-bold">(ax, data, *args, **kwargs)</span>
<span class="ansi-green-fg">   1462</span> <span style="color:rgb(175,0,255)">@functools</span><span style="color:rgb(98,98,98)">.</span>wraps(func)
<span class="ansi-green-fg">   1463</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">inner</span>(ax, <span style="color:rgb(98,98,98)">*</span>args, data<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg">   1464</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> data <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">-&gt; 1465</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> func(ax, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(0,135,0)">map</span>(sanitize_sequence, args), <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1467</span>     bound <span style="color:rgb(98,98,98)">=</span> new_sig<span style="color:rgb(98,98,98)">.</span>bind(ax, <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">   1468</span>     auto_label <span style="color:rgb(98,98,98)">=</span> (bound<span style="color:rgb(98,98,98)">.</span>arguments<span style="color:rgb(98,98,98)">.</span>get(label_namer)
<span class="ansi-green-fg">   1469</span>                   <span style="font-weight:bold;color:rgb(175,0,255)">or</span> bound<span style="color:rgb(98,98,98)">.</span>kwargs<span style="color:rgb(98,98,98)">.</span>get(label_namer))

File <span class="ansi-green-fg ansi-bold">c:\Users\danny\anaconda3\Lib\site-packages\matplotlib\axes\_axes.py:3674</span>, in <span class="ansi-cyan-fg">Axes.errorbar</span><span class="ansi-blue-fg ansi-bold">(self, x, y, yerr, xerr, fmt, ecolor, elinewidth, capsize, barsabove, lolims, uplims, xlolims, xuplims, errorevery, capthick, **kwargs)</span>
<span class="ansi-green-fg">   3671</span> res <span style="color:rgb(98,98,98)">=</span> np<span style="color:rgb(98,98,98)">.</span>zeros(err<span style="color:rgb(98,98,98)">.</span>shape, dtype<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">bool</span>)  <span style="font-style:italic;color:rgb(95,135,135)"># Default in case of nan</span>
<span class="ansi-green-fg">   3672</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> np<span style="color:rgb(98,98,98)">.</span>any(np<span style="color:rgb(98,98,98)">.</span>less(err, <span style="color:rgb(98,98,98)">-</span>err, out<span style="color:rgb(98,98,98)">=</span>res, where<span style="color:rgb(98,98,98)">=</span>(err <span style="color:rgb(98,98,98)">==</span> err))):
<span class="ansi-green-fg">   3673</span>     <span style="font-style:italic;color:rgb(95,135,135)"># like err&lt;0, but also works for timedelta and nan.</span>
<span class="ansi-green-fg ansi-bold">-&gt; 3674</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg">   3675</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">'</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>dep_axis<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">err</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)"> must not contain negative values</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg">   3676</span> <span style="font-style:italic;color:rgb(95,135,135)"># This is like</span>
<span class="ansi-green-fg">   3677</span> <span style="font-style:italic;color:rgb(95,135,135)">#     elow, ehigh = np.broadcast_to(...)</span>
<span class="ansi-green-fg">   3678</span> <span style="font-style:italic;color:rgb(95,135,135)">#     return dep - elow * ~lolims, dep + ehigh * ~uplims</span>
<span class="ansi-green-fg">   3679</span> <span style="font-style:italic;color:rgb(95,135,135)"># except that broadcast_to would strip units.</span>
<span class="ansi-green-fg">   3680</span> low, high <span style="color:rgb(98,98,98)">=</span> dep <span style="color:rgb(98,98,98)">+</span> np<span style="color:rgb(98,98,98)">.</span>vstack([<span style="color:rgb(98,98,98)">-</span>(<span style="color:rgb(98,98,98)">1</span> <span style="color:rgb(98,98,98)">-</span> lolims), <span style="color:rgb(98,98,98)">1</span> <span style="color:rgb(98,98,98)">-</span> uplims]) <span style="color:rgb(98,98,98)">*</span> err

<span class="ansi-red-fg ansi-bold">ValueError</span>: 'yerr' must not contain negative values</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="honest_inference_exploration_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Assessment of existing HonestDiD support:</strong></p>
<ul>
<li>The core estimation is solid (smoothness, relative magnitude, combined restrictions)</li>
<li><code>plot_sensitivity()</code> shows how CIs widen as <span class="math inline">\(\bar{M}\)</span> increases — a <em>separate</em> diagnostic plot</li>
<li><code>plot_honest_event_study()</code> shows robust vs.&nbsp;standard CIs side-by-side on the event study</li>
</ul>
<p><strong>What’s missing:</strong> 1. No <strong>simultaneous confidence bands</strong> (sup-t) — current CIs are pointwise 2. No <strong>smoothest confounding path</strong> overlay 3. No <strong>functional SCBs</strong> (equivalence/relevance testing) 4. No integration with the <code>ggiplot()</code> prototype from the plotting notebook 5. No way to overlay honest inference <em>inside</em> the main event study plot in a unified way</p>
</section>
<section id="gap-1-simultaneous-confidence-bands-eventstudyr" class="level2">
<h2 class="anchored" data-anchor-id="gap-1-simultaneous-confidence-bands-eventstudyr">3. Gap 1: Simultaneous Confidence Bands (eventstudyr)</h2>
<section id="the-problem-with-pointwise-cis" class="level3">
<h3 class="anchored" data-anchor-id="the-problem-with-pointwise-cis">The Problem with Pointwise CIs</h3>
<p>Standard event study plots show <strong>pointwise</strong> 95% CIs: each period’s CI has 95% coverage <em>individually</em>. But when viewing all periods together, the probability that <em>at least one</em> CI fails to cover the truth is much higher than 5%.</p>
<p><strong>eventstudyr</strong> solves this with <strong>sup-t simultaneous bands</strong> (Montiel Olea &amp; Plagborg-Moller, 2019):</p>
<p><span class="math display">\[\text{Simultaneous band} = \hat{\beta}_t \pm c_{\alpha}^{\text{sup-t}} \cdot \hat{\sigma}_t\]</span></p>
<p>where <span class="math inline">\(c_{\alpha}^{\text{sup-t}}\)</span> is the critical value from:</p>
<p><span class="math display">\[P\left(\max_t \left|\frac{\hat{\beta}_t - \beta_t}{\hat{\sigma}_t}\right| \leq c_{\alpha}^{\text{sup-t}}\right) = 1 - \alpha\]</span></p>
<p>This is computed via simulation from the multivariate normal distribution of the coefficient estimates using their variance-covariance matrix <span class="math inline">\(\hat{\Sigma}\)</span>.</p>
<p><strong>Key insight</strong>: sup-t bands are always <strong>wider</strong> than pointwise CIs. If the zero line is inside the sup-t band for all pre-treatment periods simultaneously, it provides much stronger evidence for parallel trends.</p>
<div id="supt-implementation" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_supt_critical_value(vcov, alpha<span class="op">=</span><span class="fl">0.05</span>, n_sim<span class="op">=</span><span class="dv">10000</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the sup-t critical value for simultaneous confidence bands.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Following Montiel Olea &amp; Plagborg-Moller (2019).</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    vcov : array-like (K x K)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Variance-covariance matrix of the K coefficients.</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Significance level (default 0.05 for 95% bands).</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    n_sim : int</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of simulations for computing the critical value.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">    c_supt : float</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Critical value such that P(max|Z_k/sigma_k| &lt;= c_supt) = 1 - alpha.</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> vcov.shape[<span class="dv">0</span>]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(np.diag(vcov))</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw from MVN(0, vcov)</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    draws <span class="op">=</span> rng.multivariate_normal(np.zeros(K), vcov, size<span class="op">=</span>n_sim)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize by sigma</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    t_stats <span class="op">=</span> np.<span class="bu">abs</span>(draws <span class="op">/</span> sigma[np.newaxis, :])</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Take the max over coefficients for each draw</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    max_t <span class="op">=</span> np.<span class="bu">max</span>(t_stats, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Critical value is the (1-alpha) quantile</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    c_supt <span class="op">=</span> np.quantile(max_t, <span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c_supt</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo: compare pointwise vs sup-t critical values</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">8</span>  <span class="co"># 8 pre/post periods</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">42</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a realistic vcov (correlated coefficients)</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> rng.normal(<span class="dv">0</span>, <span class="fl">0.3</span>, (K, K))</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>vcov <span class="op">=</span> A <span class="op">@</span> A.T <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> np.eye(K)  <span class="co"># positive definite</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> np.sqrt(np.diag(vcov))</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>c_pointwise <span class="op">=</span> scipy_stats.norm.ppf(<span class="fl">0.975</span>)  <span class="co"># 1.96</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>c_supt <span class="op">=</span> compute_supt_critical_value(vcov, alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Pointwise critical value (z_0.025): </span><span class="sc">{</span>c_pointwise<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Sup-t critical value (K=</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">):       </span><span class="sc">{</span>c_supt<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Sup-t / Pointwise ratio:            </span><span class="sc">{</span>c_supt <span class="op">/</span> c_pointwise<span class="sc">:.2f}</span><span class="ss">x wider'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pointwise critical value (z_0.025): 1.960
Sup-t critical value (K=8):       2.701
Sup-t / Pointwise ratio:            1.38x wider</code></pre>
</div>
</div>
<div id="supt-visual-demo" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual comparison: pointwise vs sup-t bands</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="fl">5.5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>periods_demo <span class="op">=</span> es_df[<span class="st">'period'</span>].values</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>est_demo <span class="op">=</span> es_df[<span class="st">'estimate'</span>].values</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>se_demo <span class="op">=</span> es_df[<span class="st">'se'</span>].values</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a realistic vcov for our synthetic data</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>K_demo <span class="op">=</span> <span class="bu">len</span>(periods_demo)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a simple AR(1) correlation structure</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>rho <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> np.array([[rho<span class="op">**</span><span class="bu">abs</span>(i<span class="op">-</span>j) <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(K_demo)] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(K_demo)])</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>vcov_demo <span class="op">=</span> np.outer(se_demo, se_demo) <span class="op">*</span> corr</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>c_supt_demo <span class="op">=</span> compute_supt_critical_value(vcov_demo, alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Left: pointwise CIs</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>ci_low_pw <span class="op">=</span> est_demo <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> se_demo</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>ci_high_pw <span class="op">=</span> est_demo <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> se_demo</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo, ci_low_pw, ci_high_pw, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, label<span class="op">=</span><span class="st">'95% Pointwise CI'</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo, est_demo, <span class="st">'o-'</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="op">-</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Standard: Pointwise CIs'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Treatment Effect'</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Right: sup-t bands</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>ci_low_supt <span class="op">=</span> est_demo <span class="op">-</span> c_supt_demo <span class="op">*</span> se_demo</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>ci_high_supt <span class="op">=</span> est_demo <span class="op">+</span> c_supt_demo <span class="op">*</span> se_demo</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Show pointwise as inner band</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo, ci_low_supt, ci_high_supt, alpha<span class="op">=</span><span class="fl">0.12</span>, color<span class="op">=</span><span class="st">'#dc2626'</span>, label<span class="op">=</span><span class="st">'95% Simultaneous (sup-t)'</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo, ci_low_pw, ci_high_pw, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, label<span class="op">=</span><span class="st">'95% Pointwise'</span>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo, est_demo, <span class="st">'o-'</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="op">-</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Honest: Pointwise + Sup-t Bands'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Sup-t bands are </span><span class="sc">{</span>c_supt_demo<span class="op">/</span><span class="fl">1.96</span><span class="sc">:.1f}</span><span class="ss">x wider than pointwise CIs'</span>)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'This accounts for multiple testing across all periods simultaneously'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="honest_inference_exploration_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Sup-t bands are nanx wider than pointwise CIs
This accounts for multiple testing across all periods simultaneously</code></pre>
</div>
</div>
</section>
</section>
<section id="gap-2-smoothest-confounding-path-eventstudyr" class="level2">
<h2 class="anchored" data-anchor-id="gap-2-smoothest-confounding-path-eventstudyr">4. Gap 2: Smoothest Confounding Path (eventstudyr)</h2>
<section id="the-idea" class="level3">
<h3 class="anchored" data-anchor-id="the-idea">The Idea</h3>
<p>From Freyaldenhoven et al.&nbsp;(2021), the <strong>smoothest path</strong> of confounding trend that is consistent with the estimated pre-treatment coefficients provides a visual benchmark. If the pre-treatment event study coefficients are indistinguishable from zero, this path shows what the “most conservative” violation of parallel trends could look like.</p>
<p>Formally, we solve:</p>
<p><span class="math display">\[\min_{\delta} \sum_{t} (\delta_{t+1} - 2\delta_t + \delta_{t-1})^2 \quad \text{s.t.} \quad \delta_{\text{pre}} \text{ consistent with data}\]</span></p>
<p>This gives the <strong>smoothest</strong> confound that could explain the pre-treatment pattern, which is then extrapolated post-treatment to show how much bias we might expect.</p>
<p><strong>eventstudyr</strong> overlays this as a dashed line on the event study plot.</p>
<div id="smoothest-path" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_smoothest_path(pre_estimates, pre_periods, post_periods, ref_period<span class="op">=-</span><span class="dv">1</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the smoothest confounding path consistent with pre-treatment estimates.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Minimizes the sum of squared second differences (curvature) of the path,</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    subject to the path matching the pre-treatment estimates.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    pre_estimates : array-like</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Estimated coefficients for pre-treatment periods (excluding reference).</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pre_periods : array-like</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Period indices for pre-treatment.</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">    post_periods : array-like</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Period indices for post-treatment (for extrapolation).</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ref_period : int</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">        The reference (normalized) period.</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">    all_periods : array</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Combined pre + ref + post periods.</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">    smoothest : array</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">        The smoothest confounding path for all periods.</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># All periods including reference</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    all_periods <span class="op">=</span> np.sort(np.concatenate([pre_periods, [ref_period], post_periods]))</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(all_periods)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reference period index</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    ref_idx <span class="op">=</span> np.where(all_periods <span class="op">==</span> ref_period)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pre-period indices (excluding reference)</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    pre_idx <span class="op">=</span> [np.where(all_periods <span class="op">==</span> p)[<span class="dv">0</span>][<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> pre_periods]</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Objective: minimize sum of squared second differences</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># delta_path = [delta_0, delta_1, ..., delta_{T-1}]</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second diff: delta_{t+1} - 2*delta_t + delta_{t-1}</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> objective(delta):</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        second_diffs <span class="op">=</span> delta[<span class="dv">2</span>:] <span class="op">-</span> <span class="dv">2</span><span class="op">*</span>delta[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> delta[:<span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(second_diffs<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Constraints: delta at reference = 0, delta at pre periods = estimates</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> []</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reference period = 0</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    constraints.append({<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> d, idx<span class="op">=</span>ref_idx: d[idx]})</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pre-treatment periods match estimates</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (pidx, est) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(pre_idx, pre_estimates)):</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>        constraints.append({<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> d, idx<span class="op">=</span>pidx, e<span class="op">=</span>est: d[idx] <span class="op">-</span> e})</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initial guess: linear interpolation</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.zeros(T)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(objective, x0, constraints<span class="op">=</span>constraints, method<span class="op">=</span><span class="st">'SLSQP'</span>)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_periods, result.x</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo with synthetic data</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>pre_mask <span class="op">=</span> (es_df[<span class="st">'period'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="dv">1</span>)  <span class="co"># exclude reference period -1</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>pre_est <span class="op">=</span> es_df.loc[pre_mask, <span class="st">'estimate'</span>].values</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>pre_per <span class="op">=</span> es_df.loc[pre_mask, <span class="st">'period'</span>].values</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>post_per <span class="op">=</span> es_df.loc[es_df[<span class="st">'period'</span>] <span class="op">&gt;=</span> <span class="dv">0</span>, <span class="st">'period'</span>].values</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>smooth_periods, smooth_path <span class="op">=</span> compute_smoothest_path(</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    pre_est, pre_per, post_per, ref_period<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Smoothest confounding path:'</span>)</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p, v <span class="kw">in</span> <span class="bu">zip</span>(smooth_periods, smooth_path):</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    marker <span class="op">=</span> <span class="st">' &lt;-- ref'</span> <span class="cf">if</span> p <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">else</span> (<span class="st">' &lt;-- post'</span> <span class="cf">if</span> p <span class="op">&gt;=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">''</span>)</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'  t=</span><span class="sc">{</span>p<span class="sc">:+d}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">:+.4f}{</span>marker<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Smoothest confounding path:
  t=-5: +0.1490
  t=-4: -0.0415
  t=-3: +0.1943
  t=-2: +0.4569
  t=-1: +0.0000 &lt;-- ref
  t=+0: -0.4573 &lt;-- post
  t=+1: -0.9148 &lt;-- post
  t=+2: -1.3726 &lt;-- post
  t=+3: -1.8306 &lt;-- post
  t=+4: -2.2889 &lt;-- post
  t=+5: -2.7473 &lt;-- post</code></pre>
</div>
</div>
<div id="smoothest-path-visual" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="fl">5.5</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Left: standard event study</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo, est_demo <span class="op">-</span> <span class="fl">1.96</span><span class="op">*</span>se_demo, est_demo <span class="op">+</span> <span class="fl">1.96</span><span class="op">*</span>se_demo,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo, est_demo, <span class="st">'o-'</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="op">-</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Standard Event Study'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Treatment Effect'</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Right: with smoothest confounding path</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo, est_demo <span class="op">-</span> <span class="fl">1.96</span><span class="op">*</span>se_demo, est_demo <span class="op">+</span> <span class="fl">1.96</span><span class="op">*</span>se_demo,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo, est_demo, <span class="st">'o-'</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        zorder<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Estimated'</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>ax.plot(smooth_periods, smooth_path, <span class="st">'s--'</span>, color<span class="op">=</span><span class="st">'#dc2626'</span>, markersize<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Smoothest confound'</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="op">-</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'+ Smoothest Confounding Path'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">Interpretation: The red dashed line shows the smoothest trend violation'</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'consistent with pre-treatment data, extrapolated post-treatment.'</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'This represents the potential bias under the least curvature assumption.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="honest_inference_exploration_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Interpretation: The red dashed line shows the smoothest trend violation
consistent with pre-treatment data, extrapolated post-treatment.
This represents the potential bias under the least curvature assumption.</code></pre>
</div>
</div>
</section>
</section>
<section id="gap-3-functional-scbs-fdid" class="level2">
<h2 class="anchored" data-anchor-id="gap-3-functional-scbs-fdid">5. Gap 3: Functional SCBs (fdid)</h2>
<section id="the-idea-1" class="level3">
<h3 class="anchored" data-anchor-id="the-idea-1">The Idea</h3>
<p>Fang &amp; Liebl (2026) treat the event study coefficients as a <strong>continuous function</strong> (Gaussian process), not discrete points. This enables:</p>
<ol type="1">
<li><strong>Infimum-based SCBs (pre-treatment)</strong>: For <strong>equivalence testing</strong> — if the entire band lies within <span class="math inline">\([-\epsilon, +\epsilon]\)</span>, we have evidence <em>for</em> parallel trends (not just failure to reject)</li>
<li><strong>Supremum-based SCBs (post-treatment)</strong>: For <strong>relevance testing</strong> — if the band excludes zero everywhere, there’s a significant effect at all post-treatment periods</li>
<li><strong>Honest reference bands</strong>: Shows what the bands would look like under specified assumption violations</li>
</ol>
</section>
<section id="key-innovation-two-types-of-scbs" class="level3">
<h3 class="anchored" data-anchor-id="key-innovation-two-types-of-scbs">Key Innovation: Two Types of SCBs</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 22%">
<col style="width: 16%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>Type</th>
<th>Region</th>
<th>Test</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Infimum</strong> (tighter)</td>
<td>Pre-treatment</td>
<td>Equivalence</td>
<td>Band inside <span class="math inline">\([-\epsilon, \epsilon]\)</span> <span class="math inline">\(\Rightarrow\)</span> parallel trends hold</td>
</tr>
<tr class="even">
<td><strong>Supremum</strong> (wider)</td>
<td>Post-treatment</td>
<td>Relevance</td>
<td>Band outside zero <span class="math inline">\(\Rightarrow\)</span> significant effect</td>
</tr>
</tbody>
</table>
<p>The <strong>infimum</strong> SCB is: <span class="math display">\[\hat{\beta}(t) \pm \hat{c}_{\inf,\alpha} \cdot \hat{\sigma}(t)\]</span> where <span class="math inline">\(\hat{c}_{\inf,\alpha}\)</span> satisfies <span class="math inline">\(P\left(\inf_t \left|\frac{\hat{\beta}(t) - \beta(t)}{\hat{\sigma}(t)}\right| \leq \hat{c}_{\inf,\alpha}\right) = 1 - \alpha\)</span></p>
<p>The <strong>supremum</strong> SCB is: <span class="math display">\[\hat{\beta}(t) \pm \hat{c}_{\sup,\alpha} \cdot \hat{\sigma}(t)\]</span> where <span class="math inline">\(\hat{c}_{\sup,\alpha}\)</span> satisfies <span class="math inline">\(P\left(\sup_t \left|\frac{\hat{\beta}(t) - \beta(t)}{\hat{\sigma}(t)}\right| \leq \hat{c}_{\sup,\alpha}\right) = 1 - \alpha\)</span></p>
<div id="fdid-scb-implementation" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_scb_critical_values(vcov, alpha<span class="op">=</span><span class="fl">0.05</span>, n_sim<span class="op">=</span><span class="dv">10000</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute infimum and supremum critical values for SCBs.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Following Fang &amp; Liebl (2026).</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    vcov : array-like (K x K)</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Variance-covariance matrix.</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Significance level.</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">    n_sim : int</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of simulations.</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">    c_inf : float</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Infimum critical value (for equivalence testing, tighter).</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">    c_sup : float</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Supremum critical value (for relevance testing, same as sup-t).</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> vcov.shape[<span class="dv">0</span>]</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(np.diag(vcov))</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw from MVN(0, vcov)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    draws <span class="op">=</span> rng.multivariate_normal(np.zeros(K), vcov, size<span class="op">=</span>n_sim)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    t_stats <span class="op">=</span> np.<span class="bu">abs</span>(draws <span class="op">/</span> sigma[np.newaxis, :])</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Supremum: max across coefficients (same as sup-t)</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    max_t <span class="op">=</span> np.<span class="bu">max</span>(t_stats, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    c_sup <span class="op">=</span> np.quantile(max_t, <span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Infimum: min across coefficients (tighter bands)</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    min_t <span class="op">=</span> np.<span class="bu">min</span>(t_stats, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    c_inf <span class="op">=</span> np.quantile(min_t, <span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c_inf, c_sup</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo: compare all three critical values</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>K_demo <span class="op">=</span> <span class="bu">len</span>(periods_demo)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>rho <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>corr_demo <span class="op">=</span> np.array([[rho<span class="op">**</span><span class="bu">abs</span>(i<span class="op">-</span>j) <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(K_demo)] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(K_demo)])</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>vcov_full <span class="op">=</span> np.outer(se_demo, se_demo) <span class="op">*</span> corr_demo</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>c_inf, c_sup <span class="op">=</span> compute_scb_critical_values(vcov_full)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Pointwise critical value: </span><span class="sc">{</span><span class="fl">1.96</span><span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Infimum critical value:   </span><span class="sc">{</span>c_inf<span class="sc">:.3f}</span><span class="ss">  (tighter - for equivalence testing)'</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Supremum critical value:  </span><span class="sc">{</span>c_sup<span class="sc">:.3f}</span><span class="ss">  (wider  - for relevance testing)'</span>)</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Infimum &lt; Pointwise &lt; Supremum'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pointwise critical value: 1.960
Infimum critical value:   0.339  (tighter - for equivalence testing)
Supremum critical value:  nan  (wider  - for relevance testing)

Infimum &lt; Pointwise &lt; Supremum</code></pre>
</div>
</div>
<div id="fdid-visual-demo" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual: fdid-style event study with different SCBs for pre vs post</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>pre_mask <span class="op">=</span> periods_demo <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>post_mask <span class="op">=</span> periods_demo <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-treatment: infimum SCBs (equivalence testing)</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ci_inf_low <span class="op">=</span> est_demo <span class="op">-</span> c_inf <span class="op">*</span> se_demo</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ci_inf_high <span class="op">=</span> est_demo <span class="op">+</span> c_inf <span class="op">*</span> se_demo</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-treatment: supremum SCBs (relevance testing)</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>ci_sup_low <span class="op">=</span> est_demo <span class="op">-</span> c_sup <span class="op">*</span> se_demo</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>ci_sup_high <span class="op">=</span> est_demo <span class="op">+</span> c_sup <span class="op">*</span> se_demo</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Also show pointwise for comparison</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>ci_pw_low <span class="op">=</span> est_demo <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> se_demo</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>ci_pw_high <span class="op">=</span> est_demo <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> se_demo</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-treatment region</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo[pre_mask], ci_inf_low[pre_mask], ci_inf_high[pre_mask],</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>, label<span class="op">=</span><span class="ss">f'Pre: Infimum SCB (c=</span><span class="sc">{</span>c_inf<span class="sc">:.2f}</span><span class="ss">)'</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-treatment region</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>ax.fill_between(periods_demo[post_mask], ci_sup_low[post_mask], ci_sup_high[post_mask],</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'#dc2626'</span>, label<span class="op">=</span><span class="ss">f'Post: Supremum SCB (c=</span><span class="sc">{</span>c_sup<span class="sc">:.2f}</span><span class="ss">)'</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Pointwise CIs (dashed outline)</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo, ci_pw_low, <span class="st">':'</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo, ci_pw_high, <span class="st">':'</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'Pointwise CI (c=1.96)'</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Point estimates</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo[pre_mask], est_demo[pre_mask], <span class="st">'o-'</span>, color<span class="op">=</span><span class="st">'#2563eb'</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>ax.plot(periods_demo[post_mask], est_demo[post_mask], <span class="st">'o-'</span>, color<span class="op">=</span><span class="st">'#dc2626'</span>,</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Equivalence region (epsilon band around zero)</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>ax.axhspan(<span class="op">-</span>epsilon, epsilon, alpha<span class="op">=</span><span class="fl">0.06</span>, color<span class="op">=</span><span class="st">'#16a34a'</span>, label<span class="op">=</span><span class="ss">f'Equivalence region (epsilon=</span><span class="sc">{</span>epsilon<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="op">-</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'fdid-Style: Infimum SCB (pre) + Supremum SCB (post)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Treatment Effect'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">Interpretation:'</span>)</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'- Pre-treatment: Infimum SCBs are TIGHTER than pointwise CIs.'</span>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  If infimum band is inside the green equivalence region, we have'</span>)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  evidence FOR parallel trends (not just failure to reject).'</span>)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'- Post-treatment: Supremum SCBs are WIDER than pointwise CIs.'</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  If supremum band excludes zero, the treatment effect is significant'</span>)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  at ALL post-treatment periods simultaneously.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="honest_inference_exploration_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Interpretation:
- Pre-treatment: Infimum SCBs are TIGHTER than pointwise CIs.
  If infimum band is inside the green equivalence region, we have
  evidence FOR parallel trends (not just failure to reject).
- Post-treatment: Supremum SCBs are WIDER than pointwise CIs.
  If supremum band excludes zero, the treatment effect is significant
  at ALL post-treatment periods simultaneously.</code></pre>
</div>
</div>
</section>
</section>
<section id="insights-from-the-papers" class="level2">
<h2 class="anchored" data-anchor-id="insights-from-the-papers">6. Insights from the Papers</h2>
<section id="freyaldenhoven-hansen-perez-perez-shapiro-2021" class="level3">
<h3 class="anchored" data-anchor-id="freyaldenhoven-hansen-perez-perez-shapiro-2021">6.1. Freyaldenhoven, Hansen, Perez Perez, Shapiro (2021)</h3>
<p><strong>Key recommendations for event study visualization:</strong></p>
<ol type="1">
<li><p><strong>Use cumulative parameterization</strong>: Instead of showing <span class="math inline">\(\beta_t\)</span> (level effects), show <span class="math inline">\(\sum_{s \leq t} \beta_s\)</span> (cumulative effects). This is more interpretable and comparable across studies.</p></li>
<li><p><strong>Report simultaneous CIs</strong>: Pointwise CIs are misleading for joint hypothesis testing. Sup-t bands provide correct simultaneous coverage.</p></li>
<li><p><strong>Overlay the smoothest confounding path</strong>: Shows the most conservative violation of parallel trends consistent with the data.</p></li>
<li><p><strong>Pre-trend tests</strong>: F-test for joint significance of pre-treatment coefficients is more powerful than visual inspection.</p></li>
<li><p><strong>Careful with the reference period</strong>: The choice of normalization period affects interpretation.</p></li>
</ol>
</section>
<section id="roth-2026-interpreting-event-studies-from-recent-did-methods" class="level3">
<h3 class="anchored" data-anchor-id="roth-2026-interpreting-event-studies-from-recent-did-methods">6.2. Roth (2026) — “Interpreting Event-Studies from Recent DiD Methods”</h3>
<p><strong>Critical warning for modern DiD practitioners:</strong></p>
<blockquote class="blockquote">
<p>Modern DiD methods (Callaway-Sant’Anna, Borusyak-Jaravel-Spiess) construct pre- and post-treatment coefficients <strong>asymmetrically</strong>. Pre-treatment coefficients are 2x2 DiD comparisons, while post-treatment coefficients are the actual treatment effects of interest.</p>
</blockquote>
<p><strong>Implications:</strong> 1. <strong>Visual pre-trend tests are misleading</strong>: Small pre-treatment coefficients do <em>not</em> necessarily mean parallel trends hold 2. <strong>Pre-testing can cause distortions</strong>: Conditioning on passing a visual pre-trend test biases the post-treatment estimates 3. <strong>Standard event study heuristics break down</strong>: The “parallel pre-trends” visual check that works for TWFE does NOT work for modern estimators</p>
<p><strong>Recommendation</strong>: Use formal sensitivity analysis (HonestDiD) rather than visual pre-trend inspection, especially with modern DiD methods.</p>
</section>
<section id="implications-for-our-contribution" class="level3">
<h3 class="anchored" data-anchor-id="implications-for-our-contribution">6.3. Implications for Our Contribution</h3>
<p>These papers reinforce each other: - Roth (2026) says: don’t rely on visual pre-trend tests alone - Freyaldenhoven et al.&nbsp;(2021) says: if you do visualize, use simultaneous bands + smoothest paths - Rambachan &amp; Roth (2023) says: supplement with formal sensitivity analysis - Fang &amp; Liebl (2026) says: unify everything with functional SCBs + equivalence testing</p>
<p><strong>Our contribution should provide all of these as composable layers on top of the standard event study plot.</strong></p>
</section>
</section>
<section id="compatibility-assessment" class="level2">
<h2 class="anchored" data-anchor-id="compatibility-assessment">7. Compatibility Assessment</h2>
<section id="are-these-approaches-compatible-or-mutually-exclusive" class="level3">
<h3 class="anchored" data-anchor-id="are-these-approaches-compatible-or-mutually-exclusive">Are these approaches compatible or mutually exclusive?</h3>
<p><strong>They are strongly complementary.</strong> They address different aspects of the same problem:</p>
<pre><code>Event Study Plot
|
+-- Layer 0: Point estimates + pointwise CIs (current diff-diff)
|
+-- Layer 1: Visualization improvements (ggfixest-style)
|   +-- Ribbon CIs, nested CIs, multi-model, aggregate effects
|
+-- Layer 2: Simultaneous inference (eventstudyr)
|   +-- Sup-t bands (wider CIs with correct joint coverage)
|   +-- Smoothest confounding path overlay
|
+-- Layer 3: Sensitivity analysis (HonestDiD)
|   +-- Separate sensitivity plot (CI vs. M)
|   +-- Honest CIs overlaid on event study
|   +-- Breakdown values
|
+-- Layer 4: Functional inference (fdid)
    +-- Infimum SCBs for pre-treatment (equivalence testing)
    +-- Supremum SCBs for post-treatment (relevance testing)
    +-- Honest reference bands</code></pre>
</section>
<section id="potential-tensions" class="level3">
<h3 class="anchored" data-anchor-id="potential-tensions">Potential Tensions</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 36%">
<col style="width: 63%">
</colgroup>
<thead>
<tr class="header">
<th>Issue</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HonestDiD uses separate sensitivity plots vs.&nbsp;fdid embeds in event study</td>
<td>Both are useful — keep sensitivity plot <em>and</em> add overlaid honest bands</td>
</tr>
<tr class="even">
<td>Sup-t bands (eventstudyr) vs.&nbsp;supremum SCBs (fdid)</td>
<td>They’re the <strong>same</strong> for post-treatment. Sup-t = supremum SCB. Unify.</td>
</tr>
<tr class="odd">
<td>Infimum SCBs (fdid) are novel</td>
<td>No conflict — this is a genuinely new feature. Add as option.</td>
</tr>
<tr class="even">
<td>Roth (2026) warns about visual pre-trends</td>
<td>Compatible — formal tests supplement (not replace) plots. Add warnings.</td>
</tr>
</tbody>
</table>
</section>
<section id="the-unified-vision" class="level3">
<h3 class="anchored" data-anchor-id="the-unified-vision">The Unified Vision</h3>
<p>One <code>ggiplot()</code> function that can compose all layers:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ggiplot(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    results,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    geom_style<span class="op">=</span><span class="st">'ribbon'</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    ci_level<span class="op">=</span>[<span class="fl">0.80</span>, <span class="fl">0.95</span>],</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Honest inference options:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    ci_type<span class="op">=</span><span class="st">'pointwise'</span>,       <span class="co"># 'pointwise', 'sup-t', 'fdid'</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    show_smoothest_path<span class="op">=</span><span class="va">True</span>,  <span class="co"># eventstudyr-style overlay</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    honest_M<span class="op">=</span><span class="fl">1.0</span>,             <span class="co"># HonestDiD-style robust CIs</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    equivalence_eps<span class="op">=</span><span class="fl">0.5</span>,       <span class="co"># fdid-style equivalence region</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    aggr_eff<span class="op">=</span><span class="st">'post'</span>,          <span class="co"># aggregate effects overlay</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="prototypes" class="level2">
<h2 class="anchored" data-anchor-id="prototypes">8. Prototypes</h2>
<p>Now let’s prototype the key missing features that combine insights from all packages.</p>
<section id="enhanced-iplot_data-with-honest-inference" class="level3">
<h3 class="anchored" data-anchor-id="enhanced-iplot_data-with-honest-inference">8.1. Enhanced <code>iplot_data()</code> with Honest Inference</h3>
<div id="proto-iplot-data-honest" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> iplot_data(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    results,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    ci_level<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    ci_type<span class="op">=</span><span class="st">'pointwise'</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    vcov<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    reference_period<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    n_sim<span class="op">=</span><span class="dv">10000</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract tidy event study data with optional honest inference bands.</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">    results : DataFrame or diff-diff result object</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Event study results.</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ci_level : float</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Confidence level.</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co">    ci_type : str</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co">        'pointwise' (standard), 'sup-t' (simultaneous), or 'fdid' (functional).</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co">    vcov : array-like, optional</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Variance-covariance matrix. Required for 'sup-t' and 'fdid'.</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co">        If None and ci_type != 'pointwise', falls back to diagonal (pointwise).</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co">    reference_period : int, optional</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co">        The reference period (normalized to 0).</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with columns: period, estimate, se, ci_low, ci_high, ci_level, ci_type, is_ref</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract base data</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(results, pd.DataFrame):</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> results.copy()</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'effect'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">'effect'</span>: <span class="st">'estimate'</span>})</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(results, <span class="st">'event_study_effects'</span>):</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>        es <span class="op">=</span> results.event_study_effects</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> []</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry <span class="kw">in</span> es:</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> entry.get(<span class="st">'event_time'</span>, entry.get(<span class="st">'period'</span>, <span class="dv">0</span>))</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>            est <span class="op">=</span> entry.get(<span class="st">'att'</span>, entry.get(<span class="st">'estimate'</span>, <span class="dv">0</span>))</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>            se_val <span class="op">=</span> entry.get(<span class="st">'se'</span>, <span class="dv">0</span>)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>            rows.append({<span class="st">'period'</span>: p, <span class="st">'estimate'</span>: est, <span class="st">'se'</span>: se_val})</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(rows).sort_values(<span class="st">'period'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(results, <span class="st">'period_effects'</span>):</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MultiPeriodDiDResults</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        pe <span class="op">=</span> results.period_effects</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> []</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p, info <span class="kw">in</span> pe.items():</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(info, <span class="bu">dict</span>):</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>                rows.append({<span class="st">'period'</span>: p, <span class="st">'estimate'</span>: info.get(<span class="st">'att'</span>, <span class="dv">0</span>), <span class="st">'se'</span>: info.get(<span class="st">'se'</span>, <span class="dv">0</span>)})</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>                rows.append({<span class="st">'period'</span>: p, <span class="st">'estimate'</span>: info, <span class="st">'se'</span>: <span class="dv">0</span>})</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame(rows).sort_values(<span class="st">'period'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="ss">f'Unsupported result type: </span><span class="sc">{</span><span class="bu">type</span>(results)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> df[<span class="st">'period'</span>].values</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    estimates <span class="op">=</span> df[<span class="st">'estimate'</span>].values</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    se_vals <span class="op">=</span> df[<span class="st">'se'</span>].values</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> <span class="bu">len</span>(periods)</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute critical values based on ci_type</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ci_type <span class="op">==</span> <span class="st">'pointwise'</span>:</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> scipy_stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ci_level) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ci_low'</span>] <span class="op">=</span> estimates <span class="op">-</span> z <span class="op">*</span> se_vals</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ci_high'</span>] <span class="op">=</span> estimates <span class="op">+</span> z <span class="op">*</span> se_vals</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> ci_type <span class="op">==</span> <span class="st">'sup-t'</span>:</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vcov <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fall back to diagonal (equivalent to Bonferroni-like correction)</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>            vcov <span class="op">=</span> np.diag(se_vals<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>        c_sup <span class="op">=</span> compute_supt_critical_value(vcov, alpha<span class="op">=</span><span class="dv">1</span><span class="op">-</span>ci_level, n_sim<span class="op">=</span>n_sim, seed<span class="op">=</span>seed)</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ci_low'</span>] <span class="op">=</span> estimates <span class="op">-</span> c_sup <span class="op">*</span> se_vals</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ci_high'</span>] <span class="op">=</span> estimates <span class="op">+</span> c_sup <span class="op">*</span> se_vals</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> ci_type <span class="op">==</span> <span class="st">'fdid'</span>:</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> vcov <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>            vcov <span class="op">=</span> np.diag(se_vals<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> reference_period <span class="cf">if</span> reference_period <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>        pre_idx <span class="op">=</span> np.where(periods <span class="op">&lt;</span> ref)[<span class="dv">0</span>]</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>        post_idx <span class="op">=</span> np.where(periods <span class="op">&gt;=</span> <span class="dv">0</span>)[<span class="dv">0</span>]</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute separate critical values for pre and post</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(pre_idx) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>            vcov_pre <span class="op">=</span> vcov[np.ix_(pre_idx, pre_idx)]</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>            c_inf_pre, _ <span class="op">=</span> compute_scb_critical_values(</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>                vcov_pre, alpha<span class="op">=</span><span class="dv">1</span><span class="op">-</span>ci_level, n_sim<span class="op">=</span>n_sim, seed<span class="op">=</span>seed)</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>            c_inf_pre <span class="op">=</span> scipy_stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ci_level) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(post_idx) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>            vcov_post <span class="op">=</span> vcov[np.ix_(post_idx, post_idx)]</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>            _, c_sup_post <span class="op">=</span> compute_scb_critical_values(</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>                vcov_post, alpha<span class="op">=</span><span class="dv">1</span><span class="op">-</span>ci_level, n_sim<span class="op">=</span>n_sim, seed<span class="op">=</span>seed)</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>            c_sup_post <span class="op">=</span> scipy_stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ci_level) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply different critical values to pre vs post</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>        cv <span class="op">=</span> np.full(K, scipy_stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ci_level) <span class="op">/</span> <span class="dv">2</span>))  <span class="co"># default pointwise</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>        cv[pre_idx] <span class="op">=</span> c_inf_pre</span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>        cv[post_idx] <span class="op">=</span> c_sup_post</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ci_low'</span>] <span class="op">=</span> estimates <span class="op">-</span> cv <span class="op">*</span> se_vals</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'ci_high'</span>] <span class="op">=</span> estimates <span class="op">+</span> cv <span class="op">*</span> se_vals</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f'Unknown ci_type: </span><span class="sc">{</span>ci_type<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ci_level'</span>] <span class="op">=</span> ci_level</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ci_type'</span>] <span class="op">=</span> ci_type</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_ref'</span>] <span class="op">=</span> df[<span class="st">'period'</span>] <span class="op">==</span> reference_period <span class="cf">if</span> reference_period <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[[<span class="st">'period'</span>, <span class="st">'estimate'</span>, <span class="st">'se'</span>, <span class="st">'ci_low'</span>, <span class="st">'ci_high'</span>, <span class="st">'ci_level'</span>, <span class="st">'ci_type'</span>, <span class="st">'is_ref'</span>]]</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo: compare all three CI types</span></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ct <span class="kw">in</span> [<span class="st">'pointwise'</span>, <span class="st">'sup-t'</span>, <span class="st">'fdid'</span>]:</span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>    td <span class="op">=</span> iplot_data(es_df, ci_level<span class="op">=</span><span class="fl">0.95</span>, ci_type<span class="op">=</span>ct, vcov<span class="op">=</span>vcov_full, reference_period<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>    mean_width <span class="op">=</span> (td[<span class="st">'ci_high'</span>] <span class="op">-</span> td[<span class="st">'ci_low'</span>]).mean()</span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>ct<span class="sc">:12s}</span><span class="ss">: mean CI width = </span><span class="sc">{</span>mean_width<span class="sc">:.3f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="enhanced-ggiplot-with-honest-inference-layers" class="level3">
<h3 class="anchored" data-anchor-id="enhanced-ggiplot-with-honest-inference-layers">8.2. Enhanced <code>ggiplot()</code> with Honest Inference Layers</h3>
<div id="proto-ggiplot-honest" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ggiplot(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    results,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Core options</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    geom_style<span class="op">=</span><span class="st">'ribbon'</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    ci_level<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    reference_period<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Honest inference options</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    ci_type<span class="op">=</span><span class="st">'pointwise'</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    vcov<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    show_pointwise<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    show_smoothest_path<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    equivalence_eps<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate effects</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    aggr_eff<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aesthetics</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'#2563eb'</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    post_color<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">6</span>),</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Event Study'</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">'Period Relative to Treatment'</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">'Treatment Effect'</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    show<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    n_sim<span class="op">=</span><span class="dv">10000</span>,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Enhanced event study plot with honest inference layers.</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="co">    Combines insights from ggfixest, HonestDiD, eventstudyr, and fdid.</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="co">    ci_type : str</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="co">        'pointwise' (standard), 'sup-t' (simultaneous bands from eventstudyr),</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="co">        or 'fdid' (functional SCBs with infimum pre / supremum post).</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a><span class="co">    show_pointwise : bool</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="co">        If ci_type != 'pointwise', also show pointwise CIs as dashed outline.</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="co">    show_smoothest_path : bool</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="co">        Overlay the smoothest confounding path (Freyaldenhoven et al.).</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a><span class="co">    equivalence_eps : float or None</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a><span class="co">        If set, show equivalence region [-eps, +eps] for pre-treatment (fdid).</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> post_color <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>        post_color <span class="op">=</span> <span class="st">'#dc2626'</span> <span class="cf">if</span> ci_type <span class="op">==</span> <span class="st">'fdid'</span> <span class="cf">else</span> color</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    ref <span class="op">=</span> reference_period <span class="cf">if</span> reference_period <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get tidy data</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    td <span class="op">=</span> iplot_data(results, ci_level<span class="op">=</span>ci_level, ci_type<span class="op">=</span>ci_type,</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>                    vcov<span class="op">=</span>vcov, reference_period<span class="op">=</span>reference_period,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>                    n_sim<span class="op">=</span>n_sim, seed<span class="op">=</span>seed)</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> td[<span class="st">'period'</span>].values</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    estimates <span class="op">=</span> td[<span class="st">'estimate'</span>].values</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    ci_low <span class="op">=</span> td[<span class="st">'ci_low'</span>].values</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>    ci_high <span class="op">=</span> td[<span class="st">'ci_high'</span>].values</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    pre_mask <span class="op">=</span> periods <span class="op">&lt;</span> ref</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>    post_mask <span class="op">=</span> periods <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    ref_mask <span class="op">=</span> periods <span class="op">==</span> ref</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Label for CI type</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>    ci_labels <span class="op">=</span> {</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pointwise'</span>: <span class="st">'Pointwise CI'</span>,</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sup-t'</span>: <span class="st">'Simultaneous (sup-t) band'</span>,</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fdid'</span>: <span class="st">'Functional SCB'</span>,</span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> geom_style <span class="op">==</span> <span class="st">'ribbon'</span>:</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ci_type <span class="op">==</span> <span class="st">'fdid'</span>:</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Different colors for pre vs post</span></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Pre: infimum (tighter)</span></span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pre_mask.<span class="bu">any</span>():</span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>                p_pre <span class="op">=</span> periods[pre_mask <span class="op">|</span> ref_mask]</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>                ci_l_pre <span class="op">=</span> np.concatenate([ci_low[pre_mask], ci_low[ref_mask]])</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>                ci_h_pre <span class="op">=</span> np.concatenate([ci_high[pre_mask], ci_high[ref_mask]])</span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>                e_pre <span class="op">=</span> np.concatenate([estimates[pre_mask], estimates[ref_mask]])</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>                sort_idx <span class="op">=</span> np.argsort(p_pre)</span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>                ax.fill_between(p_pre[sort_idx], ci_l_pre[sort_idx], ci_h_pre[sort_idx],</span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>                                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span>color, label<span class="op">=</span><span class="st">'Pre: Infimum SCB'</span>)</span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>                ax.plot(p_pre[sort_idx], e_pre[sort_idx], <span class="st">'o-'</span>, color<span class="op">=</span>color,</span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>                        markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Post: supremum (wider)</span></span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> post_mask.<span class="bu">any</span>():</span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>                ax.fill_between(periods[post_mask], ci_low[post_mask], ci_high[post_mask],</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>                                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span>post_color, label<span class="op">=</span><span class="st">'Post: Supremum SCB'</span>)</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>                ax.plot(periods[post_mask], estimates[post_mask], <span class="st">'o-'</span>, color<span class="op">=</span>post_color,</span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>                        markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>            ax.fill_between(periods, ci_low, ci_high, alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span>color,</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>                            label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>ci_level<span class="sc">:.0%}</span><span class="ss"> </span><span class="sc">{</span>ci_labels[ci_type]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>            ax.plot(periods, estimates, <span class="st">'o-'</span>, color<span class="op">=</span>color, markersize<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>                    linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> geom_style <span class="op">==</span> <span class="st">'errorbar'</span>:</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ci_type <span class="op">==</span> <span class="st">'fdid'</span>:</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pre_mask.<span class="bu">any</span>():</span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a>                p_pre <span class="op">=</span> periods[pre_mask <span class="op">|</span> ref_mask]</span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a>                e_pre <span class="op">=</span> estimates[pre_mask <span class="op">|</span> ref_mask]</span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>                cl_pre <span class="op">=</span> ci_low[pre_mask <span class="op">|</span> ref_mask]</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>                ch_pre <span class="op">=</span> ci_high[pre_mask <span class="op">|</span> ref_mask]</span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>                ax.errorbar(p_pre, e_pre,</span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a>                            yerr<span class="op">=</span>[e_pre <span class="op">-</span> cl_pre, ch_pre <span class="op">-</span> e_pre],</span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>                            fmt<span class="op">=</span><span class="st">'o-'</span>, color<span class="op">=</span>color, capsize<span class="op">=</span><span class="dv">4</span>, markersize<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a>                            linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="st">'Pre: Infimum SCB'</span>)</span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> post_mask.<span class="bu">any</span>():</span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a>                ax.errorbar(periods[post_mask], estimates[post_mask],</span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>                            yerr<span class="op">=</span>[estimates[post_mask] <span class="op">-</span> ci_low[post_mask],</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a>                                  ci_high[post_mask] <span class="op">-</span> estimates[post_mask]],</span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a>                            fmt<span class="op">=</span><span class="st">'o-'</span>, color<span class="op">=</span>post_color, capsize<span class="op">=</span><span class="dv">4</span>, markersize<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a>                            linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="st">'Post: Supremum SCB'</span>)</span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a>            ax.errorbar(periods, estimates,</span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a>                        yerr<span class="op">=</span>[estimates <span class="op">-</span> ci_low, ci_high <span class="op">-</span> estimates],</span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a>                        fmt<span class="op">=</span><span class="st">'o-'</span>, color<span class="op">=</span>color, capsize<span class="op">=</span><span class="dv">4</span>, markersize<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a>                        linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>ci_level<span class="sc">:.0%}</span><span class="ss"> </span><span class="sc">{</span>ci_labels[ci_type]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show pointwise CIs as dashed outline when using honest bands</span></span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_pointwise <span class="kw">and</span> ci_type <span class="op">!=</span> <span class="st">'pointwise'</span>:</span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a>        td_pw <span class="op">=</span> iplot_data(results, ci_level<span class="op">=</span>ci_level, ci_type<span class="op">=</span><span class="st">'pointwise'</span>,</span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a>                           reference_period<span class="op">=</span>reference_period)</span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a>        ax.plot(td_pw[<span class="st">'period'</span>], td_pw[<span class="st">'ci_low'</span>], <span class="st">':'</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a>        ax.plot(td_pw[<span class="st">'period'</span>], td_pw[<span class="st">'ci_high'</span>], <span class="st">':'</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Pointwise CI'</span>)</span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smoothest confounding path overlay</span></span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_smoothest_path:</span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>        pre_est_mask <span class="op">=</span> (periods <span class="op">&lt;</span> ref) <span class="op">&amp;</span> (periods <span class="op">!=</span> ref)</span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pre_est_mask.<span class="bu">sum</span>() <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a>            sp_periods, sp_path <span class="op">=</span> compute_smoothest_path(</span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a>                estimates[pre_est_mask], periods[pre_est_mask],</span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a>                periods[post_mask], ref_period<span class="op">=</span>ref</span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a>            ax.plot(sp_periods, sp_path, <span class="st">'s--'</span>, color<span class="op">=</span><span class="st">'#f59e0b'</span>, markersize<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a>                    linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Smoothest confound'</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Equivalence region</span></span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> equivalence_eps <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>        ax.axhspan(<span class="op">-</span>equivalence_eps, equivalence_eps, alpha<span class="op">=</span><span class="fl">0.06</span>, color<span class="op">=</span><span class="st">'#16a34a'</span>,</span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span><span class="ss">f'Equivalence region (eps=</span><span class="sc">{</span>equivalence_eps<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate effect overlay</span></span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> aggr_eff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> aggr_eff <span class="kw">in</span> (<span class="st">'post'</span>, <span class="st">'both'</span>):</span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a>            post_est <span class="op">=</span> estimates[post_mask]</span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a>            post_se <span class="op">=</span> td[<span class="st">'se'</span>].values[post_mask]</span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(post_est) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a>                mean_eff <span class="op">=</span> post_est.mean()</span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a>                mean_se <span class="op">=</span> np.sqrt(np.mean(post_se<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb26-156"><a href="#cb26-156" aria-hidden="true" tabindex="-1"></a>                z <span class="op">=</span> scipy_stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ci_level) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a>                ax.axhspan(mean_eff <span class="op">-</span> z<span class="op">*</span>mean_se, mean_eff <span class="op">+</span> z<span class="op">*</span>mean_se,</span>
<span id="cb26-158"><a href="#cb26-158" aria-hidden="true" tabindex="-1"></a>                           alpha<span class="op">=</span><span class="fl">0.08</span>, color<span class="op">=</span><span class="st">'#dc2626'</span>)</span>
<span id="cb26-159"><a href="#cb26-159" aria-hidden="true" tabindex="-1"></a>                ax.axhline(mean_eff, color<span class="op">=</span><span class="st">'#dc2626'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb26-160"><a href="#cb26-160" aria-hidden="true" tabindex="-1"></a>                           label<span class="op">=</span><span class="ss">f'Mean Post ATT = </span><span class="sc">{</span>mean_eff<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb26-161"><a href="#cb26-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-162"><a href="#cb26-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reference lines</span></span>
<span id="cb26-163"><a href="#cb26-163" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-164"><a href="#cb26-164" aria-hidden="true" tabindex="-1"></a>    ax.axvline(ref <span class="op">+</span> <span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb26-165"><a href="#cb26-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-166"><a href="#cb26-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reference period marker</span></span>
<span id="cb26-167"><a href="#cb26-167" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_period <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb26-168"><a href="#cb26-168" aria-hidden="true" tabindex="-1"></a>        ref_row <span class="op">=</span> td[td[<span class="st">'is_ref'</span>]]</span>
<span id="cb26-169"><a href="#cb26-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ref_row) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb26-170"><a href="#cb26-170" aria-hidden="true" tabindex="-1"></a>            ax.plot(reference_period, ref_row[<span class="st">'estimate'</span>].values[<span class="dv">0</span>], <span class="st">'o'</span>,</span>
<span id="cb26-171"><a href="#cb26-171" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'white'</span>, markersize<span class="op">=</span><span class="dv">10</span>, markeredgecolor<span class="op">=</span>color,</span>
<span id="cb26-172"><a href="#cb26-172" aria-hidden="true" tabindex="-1"></a>                    markeredgewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb26-173"><a href="#cb26-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-174"><a href="#cb26-174" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb26-175"><a href="#cb26-175" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(xlabel, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb26-176"><a href="#cb26-176" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(ylabel, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb26-177"><a href="#cb26-177" aria-hidden="true" tabindex="-1"></a>    ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb26-178"><a href="#cb26-178" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb26-179"><a href="#cb26-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-180"><a href="#cb26-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show:</span>
<span id="cb26-181"><a href="#cb26-181" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb26-182"><a href="#cb26-182" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb26-183"><a href="#cb26-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-184"><a href="#cb26-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb26-185"><a href="#cb26-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-186"><a href="#cb26-186" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'ggiplot() with honest inference defined'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="demo-all-ci-types-side-by-side" class="level3">
<h3 class="anchored" data-anchor-id="demo-all-ci-types-side-by-side">8.3. Demo: All CI Types Side by Side</h3>
<div id="demo-all-ci-types" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="fl">5.5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, ct <span class="kw">in</span> <span class="bu">zip</span>(axes, [<span class="st">'pointwise'</span>, <span class="st">'sup-t'</span>, <span class="st">'fdid'</span>]):</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    ggiplot(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        es_df, geom_style<span class="op">=</span><span class="st">'ribbon'</span>, ci_level<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        ci_type<span class="op">=</span>ct, vcov<span class="op">=</span>vcov_full,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        reference_period<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        show_pointwise<span class="op">=</span>(ct <span class="op">!=</span> <span class="st">'pointwise'</span>),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="ss">f'ci_type = "</span><span class="sc">{</span>ct<span class="sc">}</span><span class="ss">"'</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax, show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="demo-full-feature-combination" class="level3">
<h3 class="anchored" data-anchor-id="demo-full-feature-combination">8.4. Demo: Full Feature Combination</h3>
<div id="demo-combined" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The "everything" plot: fdid SCBs + smoothest path + equivalence region + aggregate effect</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ggiplot(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    es_df,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    geom_style<span class="op">=</span><span class="st">'ribbon'</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    ci_level<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    ci_type<span class="op">=</span><span class="st">'fdid'</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    vcov<span class="op">=</span>vcov_full,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    reference_period<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    show_pointwise<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    show_smoothest_path<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    equivalence_eps<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    aggr_eff<span class="op">=</span><span class="st">'post'</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Full Feature: fdid SCBs + Smoothest Path + Equivalence + Aggregate'</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">7</span>),</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="demo-supt-smoothest" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sup-t bands + smoothest path (eventstudyr-style)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ggiplot(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    es_df,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    geom_style<span class="op">=</span><span class="st">'ribbon'</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    ci_level<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    ci_type<span class="op">=</span><span class="st">'sup-t'</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    vcov<span class="op">=</span>vcov_full,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    reference_period<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    show_pointwise<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    show_smoothest_path<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'eventstudyr-style: Sup-t Bands + Smoothest Confounding Path'</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="demo-errorbar-variants" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same features but with errorbar style</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="fl">5.5</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>ggiplot(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    es_df, geom_style<span class="op">=</span><span class="st">'errorbar'</span>, ci_type<span class="op">=</span><span class="st">'sup-t'</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    vcov<span class="op">=</span>vcov_full, reference_period<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    show_smoothest_path<span class="op">=</span><span class="va">True</span>, show_pointwise<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Errorbar + Sup-t'</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>], show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>ggiplot(</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    es_df, geom_style<span class="op">=</span><span class="st">'errorbar'</span>, ci_type<span class="op">=</span><span class="st">'fdid'</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    vcov<span class="op">=</span>vcov_full, reference_period<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    equivalence_eps<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Errorbar + fdid SCBs'</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>], show<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="multi-model-comparison-fairness" class="level2">
<h2 class="anchored" data-anchor-id="multi-model-comparison-fairness">9. Multi-Model Comparison Fairness</h2>
<section id="the-core-issue" class="level3">
<h3 class="anchored" data-anchor-id="the-core-issue">The Core Issue</h3>
<p>When we overlay event studies from different estimators on the same plot, the coefficients may <strong>not mean the same thing</strong> — even if they look the same visually.</p>
<p>The problem boils down to one question: <strong>how is each pre-treatment coefficient <span class="math inline">\(\hat{\beta}_t\)</span> constructed?</strong></p>
<hr>
</section>
<section id="definitions-long-vs.-short-differences" class="level3">
<h3 class="anchored" data-anchor-id="definitions-long-vs.-short-differences">9.0. Definitions: Long vs.&nbsp;Short Differences</h3>
<p>Consider a simple 2-group DiD setup with treatment starting at <span class="math inline">\(t=0\)</span> and reference period <span class="math inline">\(t=-1\)</span>. Define:</p>
<p><span class="math display">\[\bar{Y}_t^{D} = \bar{Y}_t^{\text{treat}} - \bar{Y}_t^{\text{control}} \quad \text{(group difference at time } t \text{)}\]</span></p>
<p>Then:</p>
<p><strong>Long difference</strong> (relative to a <em>fixed</em> reference period): <span class="math display">\[\hat{\beta}_t^{\text{long}} = \bar{Y}_t^D - \bar{Y}_{-1}^D\]</span></p>
<p>Every period is compared to the <strong>same</strong> baseline (<span class="math inline">\(t=-1\)</span>). So <span class="math inline">\(\hat{\beta}_{-5}\)</span> tells you: “how different was the treated-control gap at <span class="math inline">\(t=-5\)</span> compared to <span class="math inline">\(t=-1\)</span>?”</p>
<p><strong>Short difference</strong> (relative to the <em>preceding</em> period): <span class="math display">\[\hat{\beta}_t^{\text{short}} = \bar{Y}_t^D - \bar{Y}_{t-1}^D\]</span></p>
<p>Each period is compared to its <strong>immediate neighbor</strong>. So <span class="math inline">\(\hat{\beta}_{-5}\)</span> tells you: “how much did the treated-control gap <em>change</em> between <span class="math inline">\(t=-6\)</span> and <span class="math inline">\(t=-5\)</span>?”</p>
<p>These are fundamentally different objects. Long differences cumulate, short differences are incremental.</p>
<div id="fs8mvadtj47" class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Concrete numerical example: Long vs Short differences</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppose Y_treat - Y_control (group gap) evolves as:</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> np.array([<span class="op">-</span><span class="dv">5</span>, <span class="op">-</span><span class="dv">4</span>, <span class="op">-</span><span class="dv">3</span>, <span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>Y_gap   <span class="op">=</span> np.array([<span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>, <span class="fl">3.0</span>, <span class="fl">6.0</span>, <span class="fl">7.0</span>, <span class="fl">8.0</span>, <span class="fl">9.0</span>])</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                    ^--- linear pre-trend ---^  ^--- treatment kicks in</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>ref <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>  <span class="co"># reference period</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>ref_idx <span class="op">=</span> np.where(periods <span class="op">==</span> ref)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Long differences: each period vs fixed reference (t=-1)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>beta_long <span class="op">=</span> Y_gap <span class="op">-</span> Y_gap[ref_idx]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Short differences: each period vs its immediate predecessor</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>beta_short <span class="op">=</span> np.zeros(<span class="bu">len</span>(periods))</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>beta_short[<span class="dv">0</span>] <span class="op">=</span> np.nan  <span class="co"># no predecessor for first period</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(periods)):</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    beta_short[i] <span class="op">=</span> Y_gap[i] <span class="op">-</span> Y_gap[i<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> pd.DataFrame({</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'period'</span>: periods,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Y_gap'</span>: Y_gap,</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'beta_long (vs t=-1)'</span>: beta_long,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'beta_short (vs t-1)'</span>: beta_short,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'=== Long vs Short Differences ==='</span>)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(example.to_string(index<span class="op">=</span><span class="va">False</span>, float_format<span class="op">=</span><span class="st">'</span><span class="sc">%.1f</span><span class="st">'</span>))</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Notice:'</span>)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  - Long diffs: pre-treatment shows a trend (-2.0, -1.5, -1.0, -0.5, 0)'</span>)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  - Short diffs: pre-treatment is constant (0.5, 0.5, 0.5, 0.5)'</span>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  - Post-treatment: long diffs = 3.0, 4.0, 5.0, 6.0 (cumulative)'</span>)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  - Post-treatment: short diffs = 3.0, 1.0, 1.0, 1.0 (incremental)'</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'KEY: If pre-trends are LINEAR, short diffs hide the trend (looks flat)!'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-each-estimator-constructs-event-study-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="how-each-estimator-constructs-event-study-coefficients">9.1. How Each Estimator Constructs Event Study Coefficients</h3>
<p>Now let’s go estimator by estimator. All of them produce event study coefficients <span class="math inline">\(\hat{\beta}_e\)</span> indexed by relative time <span class="math inline">\(e\)</span> (periods relative to treatment). All normalize <span class="math inline">\(\hat{\beta}_{-1} = 0\)</span>. But <strong>how they build the other coefficients differs</strong>.</p>
<hr>
<section id="dynamic-twfe-multiperioddid" class="level4">
<h4 class="anchored" data-anchor-id="dynamic-twfe-multiperioddid">Dynamic TWFE / MultiPeriodDiD</h4>
<p><strong>Reference</strong>: Last pre-period (<span class="math inline">\(e=-1\)</span>), dropped from the regression.</p>
<p><strong>Method</strong>: OLS regression with period dummies: <span class="math display">\[Y_{it} = \alpha_i + \gamma_t + \sum_{e \neq -1} \beta_e \cdot \mathbb{1}[t - g_i = e] + \varepsilon_{it}\]</span></p>
<p>All <span class="math inline">\(\beta_e\)</span> coefficients (both pre and post) are <strong>long differences</strong> relative to <span class="math inline">\(e=-1\)</span>.</p>
<p><span class="math inline">\(\Rightarrow\)</span> Pre-treatment <span class="math inline">\(\hat{\beta}_{-3}\)</span> answers: “how different was the gap at <span class="math inline">\(e=-3\)</span> vs.&nbsp;<span class="math inline">\(e=-1\)</span>?”</p>
<hr>
</section>
<section id="sun-abraham" class="level4">
<h4 class="anchored" data-anchor-id="sun-abraham">Sun-Abraham</h4>
<p><strong>Reference</strong>: Also <span class="math inline">\(e=-1\)</span>, also dropped from the regression.</p>
<p><strong>Method</strong>: Same regression structure as Dynamic TWFE, but with <strong>cohort-specific interactions</strong> to handle heterogeneity: <span class="math display">\[Y_{it} = \alpha_i + \gamma_t + \sum_{g} \sum_{e \neq -1} \delta_{g,e} \cdot \mathbb{1}[G_i = g] \cdot \mathbb{1}[t - g = e] + \varepsilon_{it}\]</span></p>
<p>Then aggregates: <span class="math inline">\(\hat{\beta}_e = \sum_g w_{g,e} \cdot \hat{\delta}_{g,e}\)</span> (interaction-weighted average).</p>
<p>All <span class="math inline">\(\beta_e\)</span> are still <strong>long differences</strong> relative to <span class="math inline">\(e=-1\)</span>, just with proper heterogeneity handling.</p>
<p><strong>Bottom line</strong>: Sun-Abraham is essentially TWFE done right. Same reference, same type of coefficient, same interpretation. “Dropping from regression” = normalizing to zero. It’s the same thing.</p>
<p><span class="math inline">\(\Rightarrow\)</span> <strong>Comparable to Dynamic TWFE</strong>: YES</p>
<hr>
</section>
<section id="callaway-santanna" class="level4">
<h4 class="anchored" data-anchor-id="callaway-santanna">Callaway-Sant’Anna</h4>
<p><strong>Reference</strong>: <span class="math inline">\(e=-1\)</span> (the period before treatment for each cohort <span class="math inline">\(g\)</span>).</p>
<p><strong>Method</strong>: Builds group-time ATTs <span class="math inline">\(\widehat{ATT}(g,t)\)</span> via 2x2 DiD comparisons, then aggregates to event study.</p>
<p><strong>Here’s where it gets tricky</strong>: CS has two modes for the <strong>base period</strong>:</p>
<p><strong><code>base_period='universal'</code></strong> (recommended for comparison): - ALL coefficients (pre and post) use <span class="math inline">\(t = g-1\)</span> as the comparison period - <span class="math inline">\(\hat{\beta}_e = \widehat{ATT}(g, g+e)\)</span> where each ATT compares to <span class="math inline">\(t=g-1\)</span> - This is a <strong>long difference</strong> — same as TWFE/Sun-Abraham - <span class="math inline">\(\Rightarrow\)</span> <strong>Comparable</strong>: YES</p>
<p><strong><code>base_period='varying'</code></strong> (the DEFAULT): - <strong>Post-treatment</strong>: Uses <span class="math inline">\(t=g-1\)</span> as comparison → <strong>long difference</strong> ✓ - <strong>Pre-treatment</strong>: Uses <span class="math inline">\(t-1\)</span> as comparison for each <span class="math inline">\(t\)</span> → <strong>short difference</strong> ✗ - This means pre and post coefficients are constructed with <strong>different formulas</strong> - <span class="math inline">\(\Rightarrow\)</span> <strong>Comparable</strong>: ONLY post-treatment. Pre-treatment coefficients mean something different!</p>
<hr>
</section>
<section id="imputation-did-borusyak-jaravel-spiess" class="level4">
<h4 class="anchored" data-anchor-id="imputation-did-borusyak-jaravel-spiess">Imputation DiD (Borusyak-Jaravel-Spiess)</h4>
<p>This one works completely differently from the others. No regression with period dummies at all.</p>
<p><strong>Method</strong> (two steps):</p>
<ol type="1">
<li><p><strong>Estimate the counterfactual</strong>: Using <em>only untreated observations</em> (units before they get treated + never-treated), fit unit and time fixed effects: <span class="math display">\[\hat{Y}_{it}(0) = \hat{\alpha}_i + \hat{\gamma}_t\]</span> This gives you a prediction of what <span class="math inline">\(Y\)</span> would have been <em>without treatment</em> for every unit-time.</p></li>
<li><p><strong>Compute individual treatment effects</strong>: For each treated observation: <span class="math display">\[\hat{\tau}_{it} = Y_{it} - \hat{Y}_{it}(0) = Y_{it} - \hat{\alpha}_i - \hat{\gamma}_t\]</span></p></li>
<li><p><strong>Aggregate by horizon</strong>: Group these <span class="math inline">\(\hat{\tau}_{it}\)</span> by relative time <span class="math inline">\(h = t - g_i\)</span> and average: <span class="math display">\[\hat{\beta}_h = \frac{1}{N_h} \sum_{i,t: t-g_i = h} \hat{\tau}_{it}\]</span></p></li>
</ol>
<p><strong>Reference period</strong>: BJS doesn’t naturally produce a coefficient at <span class="math inline">\(h=-1\)</span>. Since at <span class="math inline">\(h=-1\)</span> no unit is yet treated, there are no <span class="math inline">\(\hat{\tau}_{it}\)</span> to aggregate. The code <strong>manually adds</strong> <span class="math inline">\(\hat{\beta}_{-1} = 0\)</span> for plotting. That’s what “constructed” means.</p>
<p><strong>Pre-treatment coefficients</strong> (<span class="math inline">\(h &lt; -1\)</span>): These are <strong>placebo tests</strong>. They show <span class="math inline">\(Y - \hat{Y}(0)\)</span> for periods before treatment. If the model is right, these should be <span class="math inline">\(\approx 0\)</span>. They’re not “differences relative to a reference” — they’re direct residuals from the counterfactual model.</p>
<p><strong>Are they comparable?</strong> The post-treatment coefficients estimate the same thing (ATT at each relative time) and should be numerically close to the other estimators. The pre-treatment coefficients are on a similar scale but have a different construction — they test model specification, not parallel trends relative to a reference.</p>
<p><span class="math inline">\(\Rightarrow\)</span> <strong>Comparable</strong>: Post-treatment YES (same estimand). Pre-treatment: similar scale but different interpretation.</p>
<hr>
</section>
</section>
<section id="summary-table" class="level3">
<h3 class="anchored" data-anchor-id="summary-table">Summary Table</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 31%">
<col style="width: 18%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Estimator</th>
<th>Reference</th>
<th>Pre-treatment coefficients</th>
<th>Post-treatment</th>
<th>Comparable to TWFE?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Dynamic TWFE</strong></td>
<td><span class="math inline">\(e=-1\)</span> (dropped)</td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td>– (baseline)</td>
</tr>
<tr class="even">
<td><strong>Sun-Abraham</strong></td>
<td><span class="math inline">\(e=-1\)</span> (dropped)</td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td><strong>Yes</strong> (same approach, better heterogeneity)</td>
</tr>
<tr class="odd">
<td><strong>CS (universal)</strong></td>
<td><span class="math inline">\(e=-1\)</span> (fixed)</td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td><strong>Yes</strong></td>
</tr>
<tr class="even">
<td><strong>CS (varying)</strong></td>
<td><span class="math inline">\(e=-1\)</span> (fixed)</td>
<td><strong>Short diff</strong> (<span class="math inline">\(e\)</span> vs <span class="math inline">\(e-1\)</span>)</td>
<td>Long diff vs.&nbsp;<span class="math inline">\(e=-1\)</span></td>
<td><strong>Post only</strong> (pre is different!)</td>
</tr>
<tr class="odd">
<td><strong>Imputation (BJS)</strong></td>
<td><span class="math inline">\(e=-1\)</span> (constructed)</td>
<td>Placebo residuals <span class="math inline">\(Y - \hat{Y}(0)\)</span></td>
<td>Imputed <span class="math inline">\(\hat{\tau}\)</span></td>
<td><strong>Post yes</strong>, pre similar but different meaning</td>
</tr>
</tbody>
</table>
<p><strong>The safe multi-model comparisons are:</strong> - TWFE + Sun-Abraham + CS (universal) → fully comparable - Adding Imputation → post-treatment comparable, pre-treatment interpret with caution - CS (varying) → <strong>only post-treatment is comparable</strong>; pre-treatment is a different quantity</p>
</section>
<section id="visual-demo-the-kink-artifact-roth-2026" class="level3">
<h3 class="anchored" data-anchor-id="visual-demo-the-kink-artifact-roth-2026">9.2. Visual Demo: The “Kink” Artifact (Roth, 2026)</h3>
<p>Now that we understand the difference between long and short differences, let’s see why it matters visually.</p>
<p><strong>Setup</strong>: There is a <strong>linear pre-trend violation</strong> (the treated-control gap grows by 0.3 each period) but <strong>NO treatment effect at all</strong>. What does each estimator’s event study look like?</p>
<div id="1w1wxhfrmjc" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate: linear pre-trend violation, NO treatment effect</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Following Roth (2026) Figure 1</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>periods_sim <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">5</span>, <span class="dv">6</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>ref <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># True confounding: gap grows linearly at 0.3 per period</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Y_gap(t) = baseline + 0.3 * t</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># There is NO treatment effect -- just a trend violation</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>delta_true <span class="op">=</span> <span class="fl">0.3</span> <span class="op">*</span> periods_sim</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>se_sim <span class="op">=</span> np.full(<span class="bu">len</span>(periods_sim), <span class="fl">0.25</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>noise <span class="op">=</span> <span class="kw">lambda</span>: np.random.normal(<span class="dv">0</span>, <span class="fl">0.12</span>, <span class="bu">len</span>(periods_sim))</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. TWFE / MultiPeriod: ALL coefficients are long diffs vs e=-1</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># beta_t = (Y_gap_t - Y_gap_{-1}) = 0.3*t - 0.3*(-1) = 0.3*(t+1)</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>twfe_coefs <span class="op">=</span> delta_true <span class="op">-</span> delta_true[periods_sim <span class="op">==</span> ref][<span class="dv">0</span>] <span class="op">+</span> noise()</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>twfe_coefs[periods_sim <span class="op">==</span> ref] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. CS (varying): pre = SHORT diffs (t vs t-1), post = LONG diffs vs ref</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>cs_coefs <span class="op">=</span> np.zeros(<span class="bu">len</span>(periods_sim))</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, p <span class="kw">in</span> <span class="bu">enumerate</span>(periods_sim):</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> ref:</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Short diff: delta_t - delta_{t-1} = 0.3 (constant!)</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        cs_coefs[i] <span class="op">=</span> <span class="fl">0.3</span> <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.12</span>)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> p <span class="op">==</span> ref:</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        cs_coefs[i] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Long diff: delta_t - delta_{ref} = 0.3*(t - ref)</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        cs_coefs[i] <span class="op">=</span> <span class="fl">0.3</span> <span class="op">*</span> (p <span class="op">-</span> ref) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.12</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Imputation (BJS): residuals from counterfactual model</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre: Y - Y_hat(0), where Y_hat(0) is fitted on untreated obs</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co"># If model is well-specified, pre should be ~0</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="co"># But with a trend violation, pre shows the trend vs the model's "average"</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>avg_delta_pre <span class="op">=</span> np.mean(delta_true[periods_sim <span class="op">&lt;</span> <span class="dv">0</span>])</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>bjs_coefs <span class="op">=</span> delta_true <span class="op">-</span> avg_delta_pre <span class="op">+</span> noise()</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>bjs_coefs[periods_sim <span class="op">==</span> ref] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="fl">5.5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#2563eb'</span>, <span class="st">'#dc2626'</span>, <span class="st">'#16a34a'</span>]</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TWFE</span><span class="ch">\n</span><span class="st">(long diffs: pre + post)'</span>,</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CS (varying base)</span><span class="ch">\n</span><span class="st">(short diffs pre, long diffs post)"</span>,</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Imputation (BJS)</span><span class="ch">\n</span><span class="st">(residuals from counterfactual)'</span>,</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>coefs_list <span class="op">=</span> [twfe_coefs, cs_coefs, bjs_coefs]</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, coefs, title, color <span class="kw">in</span> <span class="bu">zip</span>(axes, coefs_list, titles, colors):</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(periods_sim, coefs <span class="op">-</span> <span class="fl">1.96</span><span class="op">*</span>se_sim, coefs <span class="op">+</span> <span class="fl">1.96</span><span class="op">*</span>se_sim,</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>                    alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span>color)</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    ax.plot(periods_sim, coefs, <span class="st">'o-'</span>, color<span class="op">=</span>color, markersize<span class="op">=</span><span class="dv">7</span>, linewidth<span class="op">=</span><span class="dv">2</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    ax.axvline(ref <span class="op">+</span> <span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>)</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="op">==</span> axes[<span class="dv">0</span>]:</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Estimated Coefficient'</span>)</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'TRUE EFFECT = 0 everywhere. Only a linear pre-trend violation exists.'</span>,</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">13</span>, y<span class="op">=</span><span class="fl">1.03</span>, style<span class="op">=</span><span class="st">'italic'</span>)</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'What you see:'</span>)</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  TWFE:        smooth upward line through zero, no break at treatment'</span>)</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'               --&gt; correctly suggests "just a trend, no treatment effect"'</span>)</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  CS (varying): flat pre-trends (~0.3 each) then sudden jump post-treatment'</span>)</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'               --&gt; LOOKS like a treatment effect, but it is an artifact!'</span>)</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'               --&gt; short diffs flatten the linear trend into a constant'</span>)</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'               --&gt; then post-treatment switches to long diffs = kink'</span>)</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'  BJS:         upward pre-trend, then continues post-treatment'</span>)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'               --&gt; shows the trend but normalized differently'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prototype-auto-annotation-for-multi-model-plots" class="level3">
<h3 class="anchored" data-anchor-id="prototype-auto-annotation-for-multi-model-plots">9.3. Prototype: Auto-Annotation for Multi-Model Plots</h3>
<p>Given these comparability issues, our <code>ggiplot()</code> should automatically: 1. Detect which estimators are being compared 2. Show a small text box on the plot with each model’s reference period 3. Print warnings when issues are detected (asymmetric construction, different references)</p>
<div id="2g6zziate2d" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_model_annotation(model_dict):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate a compact annotation string for multi-model plots.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows the reference period and construction type for each model.</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> []</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, results <span class="kw">in</span> model_dict.items():</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        meta <span class="op">=</span> get_estimator_metadata(results)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        ref <span class="op">=</span> meta[<span class="st">'reference_period'</span>]</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        sym <span class="op">=</span> <span class="st">'symmetric'</span> <span class="cf">if</span> meta[<span class="st">'symmetric'</span>] <span class="cf">else</span> <span class="st">'ASYMMETRIC'</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> meta[<span class="st">'symmetric'</span>] <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            sym <span class="op">=</span> <span class="st">'N/A'</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        lines.append(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: ref=</span><span class="sc">{</span>ref<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>sym<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(lines)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ggiplot_multi_annotated(</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    model_dict,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    geom_style<span class="op">=</span><span class="st">'ribbon'</span>,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    ci_level<span class="op">=</span><span class="fl">0.95</span>,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    reference_period<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    annotate<span class="op">=</span><span class="st">'auto'</span>,  <span class="co"># 'auto', 'plot', 'print', 'both', None</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">6</span>),</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Multi-Model Event Study'</span>,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    show<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Multi-model event study plot with automatic comparability annotations.</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co">    model_dict : dict</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co">        {name: (results_or_df, se_or_None)} or {name: DataFrame}</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="co">    annotate : str</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="co">        'auto' - print warnings if issues detected, annotate plot with ref periods</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="co">        'plot' - only annotate on the plot</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="co">        'print' - only print warnings</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="co">        'both' - both</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="co">        None - no annotations</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'#2563eb'</span>, <span class="st">'#dc2626'</span>, <span class="st">'#16a34a'</span>, <span class="st">'#f59e0b'</span>, <span class="st">'#8b5cf6'</span>]</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> scipy_stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ci_level) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run comparability check</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    report <span class="op">=</span> check_multi_model_comparability(model_dict)</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    has_issues <span class="op">=</span> <span class="bu">len</span>(report[<span class="st">'warnings'</span>]) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine annotation mode</span></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> annotate <span class="op">==</span> <span class="st">'auto'</span>:</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>        annotate <span class="op">=</span> <span class="st">'both'</span> <span class="cf">if</span> has_issues <span class="cf">else</span> <span class="st">'plot'</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot each model</span></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    n_models <span class="op">=</span> <span class="bu">len</span>(model_dict)</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>    dodge_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>    annotation_lines <span class="op">=</span> []</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, (name, results) <span class="kw">in</span> <span class="bu">enumerate</span>(model_dict.items()):</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> colors[idx <span class="op">%</span> <span class="bu">len</span>(colors)]</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>        meta <span class="op">=</span> get_estimator_metadata(results)</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get data (handle both DataFrames and result objects)</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(results, pd.DataFrame):</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> results.copy()</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'effect'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>                df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">'effect'</span>: <span class="st">'estimate'</span>})</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>            periods_m <span class="op">=</span> df[<span class="st">'period'</span>].values</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>            estimates_m <span class="op">=</span> df[<span class="st">'estimate'</span>].values</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>            se_m <span class="op">=</span> df[<span class="st">'se'</span>].values</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to extract from result object</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>            td <span class="op">=</span> iplot_data(results, ci_level<span class="op">=</span>ci_level, reference_period<span class="op">=</span>reference_period)</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>            periods_m <span class="op">=</span> td[<span class="st">'period'</span>].values</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>            estimates_m <span class="op">=</span> td[<span class="st">'estimate'</span>].values</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>            se_m <span class="op">=</span> td[<span class="st">'se'</span>].values</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>        offset <span class="op">=</span> (idx <span class="op">-</span> (n_models <span class="op">-</span> <span class="dv">1</span>) <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> dodge_width</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> periods_m <span class="op">+</span> offset</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> geom_style <span class="op">==</span> <span class="st">'ribbon'</span>:</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>            ax.fill_between(x, estimates_m <span class="op">-</span> z<span class="op">*</span>se_m, estimates_m <span class="op">+</span> z<span class="op">*</span>se_m,</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>                            alpha<span class="op">=</span><span class="fl">0.15</span>, color<span class="op">=</span>color)</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>            ax.plot(x, estimates_m, <span class="st">'o-'</span>, color<span class="op">=</span>color, markersize<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>                    linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span>name, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>            ax.errorbar(x, estimates_m, yerr<span class="op">=</span>z<span class="op">*</span>se_m,</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>                        fmt<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span>color, capsize<span class="op">=</span><span class="dv">3</span>, markersize<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>                        linewidth<span class="op">=</span><span class="fl">1.2</span>, label<span class="op">=</span>name)</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build annotation</span></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>        ref_str <span class="op">=</span> meta[<span class="st">'reference_period'</span>] <span class="kw">or</span> <span class="st">'?'</span></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>        sym_str <span class="op">=</span> <span class="st">''</span></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> meta[<span class="st">'symmetric'</span>] <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>            sym_str <span class="op">=</span> <span class="st">' [ASYMMETRIC]'</span></span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>        annotation_lines.append(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: ref=</span><span class="sc">{</span>ref_str<span class="sc">}{</span>sym_str<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_period <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>        ax.axvline(reference_period <span class="op">+</span> <span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Period Relative to Treatment'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Treatment Effect'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>    ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annotation on the plot</span></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> annotate <span class="kw">in</span> (<span class="st">'plot'</span>, <span class="st">'both'</span>):</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>        note_text <span class="op">=</span> <span class="st">'Base reference:</span><span class="ch">\n</span><span class="st">'</span> <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(annotation_lines)</span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.02</span>, <span class="fl">0.02</span>, note_text,</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>                transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="fl">7.5</span>,</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'bottom'</span>,</span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.4'</span>, facecolor<span class="op">=</span><span class="st">'lightyellow'</span>,</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>                          edgecolor<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>),</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a>                family<span class="op">=</span><span class="st">'monospace'</span>)</span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print warnings</span></span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> annotate <span class="kw">in</span> (<span class="st">'print'</span>, <span class="st">'both'</span>) <span class="kw">and</span> has_issues:</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'MULTI-MODEL COMPARISON WARNINGS'</span>)</span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> w <span class="kw">in</span> report[<span class="st">'warnings'</span>]:</span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'  ! </span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> report[<span class="st">'notes'</span>]:</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> n <span class="kw">in</span> report[<span class="st">'notes'</span>]:</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'  * </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'='</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show:</span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo: multi-model plot with annotations</span></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Using synthetic DataFrames to simulate different estimators</span></span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> np.array([<span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">2.5</span>, <span class="fl">3.1</span>, <span class="fl">3.8</span>, <span class="fl">4.2</span>])</span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a>periods_m <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach fake result types to DataFrames for metadata extraction</span></span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CSVaryingDF(pd.DataFrame):</span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a>    base_period <span class="op">=</span> <span class="st">'varying'</span></span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>CSVaryingDF.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'CallawaySantAnnaResults'</span></span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SADF(pd.DataFrame):</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>SADF.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'SunAbrahamResults'</span></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImpDF(pd.DataFrame):</span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a>ImpDF.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'ImputationDiDResults'</span></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>model_results_annotated <span class="op">=</span> {</span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CS (varying)"</span>: CSVaryingDF({</span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a>        <span class="st">'period'</span>: periods_m,</span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a>        <span class="st">'estimate'</span>: base <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="dv">9</span>),</span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>        <span class="st">'se'</span>: np.<span class="bu">abs</span>(np.random.normal(<span class="fl">0.35</span>, <span class="fl">0.05</span>, <span class="dv">9</span>)),</span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>    }),</span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sun-Abraham'</span>: SADF({</span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a>        <span class="st">'period'</span>: periods_m,</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a>        <span class="st">'estimate'</span>: base <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.15</span>, <span class="dv">9</span>),</span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>        <span class="st">'se'</span>: np.<span class="bu">abs</span>(np.random.normal(<span class="fl">0.3</span>, <span class="fl">0.05</span>, <span class="dv">9</span>)),</span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a>    }),</span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Imputation'</span>: ImpDF({</span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>        <span class="st">'period'</span>: periods_m,</span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a>        <span class="st">'estimate'</span>: base <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">9</span>),</span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>        <span class="st">'se'</span>: np.<span class="bu">abs</span>(np.random.normal(<span class="fl">0.25</span>, <span class="fl">0.05</span>, <span class="dv">9</span>)),</span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>    }),</span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>ggiplot_multi_annotated(</span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a>    model_results_annotated,</span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a>    geom_style<span class="op">=</span><span class="st">'errorbar'</span>,</span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a>    reference_period<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>    annotate<span class="op">=</span><span class="st">'both'</span>,</span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Multi-Model Comparison with Auto-Annotations'</span>,</span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="design-decision-how-to-annotate" class="level3">
<h3 class="anchored" data-anchor-id="design-decision-how-to-annotate">9.4. Design Decision: How to Annotate</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th>Approach</th>
<th>Pros</th>
<th>Cons</th>
<th>Recommendation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Text box on plot</strong></td>
<td>Always visible, travels with saved figure</td>
<td>Can be cluttered</td>
<td>Use for reference period info (compact)</td>
</tr>
<tr class="even">
<td><strong>Printed warning</strong></td>
<td>More detail, doesn’t clutter</td>
<td>User might miss it</td>
<td>Use for construction-type warnings</td>
</tr>
<tr class="odd">
<td><strong><code>annotate='auto'</code></strong></td>
<td>Quiet when safe, loud when dangerous</td>
<td>Might suppress info</td>
<td><strong>Default behavior</strong></td>
</tr>
</tbody>
</table>
<p><strong>Our recommendation</strong>: <code>annotate='auto'</code> as default: - Always show a small text box with reference period per model - Print detailed warnings <strong>only</strong> when issues are detected (asymmetric construction, different references, etc.) - Return the comparability <code>report</code> dict so users can inspect programmatically</p>
<p><strong>This is a genuinely novel contribution</strong> – no existing tool (ggfixest, did2s, fixest) provides any form of automatic comparability checking for multi-model event study plots.</p>
</section>
</section>
<section id="freyaldenhoven-et-al.-plot-featuresthree-specific-recommendations-from-freyaldenhoven-et-al.-2021-that-we-should-add-as-options-10.1.-parenthetical-outcome-label-suggestion-2the-y-axis-label-0-41.94-means-the-normalized-coefficient-of-0-corresponds-to-an-average-outcome-of-41.94-in-levels.-this-helps-readers-interpret-the-economic-magnitude-of-the-effects.for-example-if-hatbeta_3--0.8-and-the-baseline-is-41.94-then-the-treatment-reduced-the-outcome-by-approximately-0.841.94-approx-1.9-by-period-3.-10.2.-joint-wald-test-for-pre-trendsinstead-of-eyeballing-whether-pre-treatment-coefficients-are-close-to-zero-run-a-formal-joint-testh_0-beta_-k-beta_-k1-cdots-beta_-2-0this-is-an-f-test-wald-test-using-the-joint-variance-covariance-matrix.diff-diff-status-imputationdid-already-has-pretrend_test-returning-an-f-stat-and-p-value.-but-its-not-available-for-other-estimators-or-as-a-general-utility.-10.3.-leveling-off-testtests-whether-the-post-treatment-effects-are-constant-over-timeh_0-beta_0-beta_1-cdots-beta_kif-we-fail-to-reject-we-can-summarize-with-a-single-average-att.-the-smoothest-path-constant-effects-p-value-in-the-third-figure-from-the-paper-shows-this.diff-diff-status-not-implemented-anywhere." class="level2">
<h2 class="anchored" data-anchor-id="freyaldenhoven-et-al.-plot-featuresthree-specific-recommendations-from-freyaldenhoven-et-al.-2021-that-we-should-add-as-options-10.1.-parenthetical-outcome-label-suggestion-2the-y-axis-label-0-41.94-means-the-normalized-coefficient-of-0-corresponds-to-an-average-outcome-of-41.94-in-levels.-this-helps-readers-interpret-the-economic-magnitude-of-the-effects.for-example-if-hatbeta_3--0.8-and-the-baseline-is-41.94-then-the-treatment-reduced-the-outcome-by-approximately-0.841.94-approx-1.9-by-period-3.-10.2.-joint-wald-test-for-pre-trendsinstead-of-eyeballing-whether-pre-treatment-coefficients-are-close-to-zero-run-a-formal-joint-testh_0-beta_-k-beta_-k1-cdots-beta_-2-0this-is-an-f-test-wald-test-using-the-joint-variance-covariance-matrix.diff-diff-status-imputationdid-already-has-pretrend_test-returning-an-f-stat-and-p-value.-but-its-not-available-for-other-estimators-or-as-a-general-utility.-10.3.-leveling-off-testtests-whether-the-post-treatment-effects-are-constant-over-timeh_0-beta_0-beta_1-cdots-beta_kif-we-fail-to-reject-we-can-summarize-with-a-single-average-att.-the-smoothest-path-constant-effects-p-value-in-the-third-figure-from-the-paper-shows-this.diff-diff-status-not-implemented-anywhere.">10. Freyaldenhoven et al.&nbsp;Plot FeaturesThree specific recommendations from Freyaldenhoven et al.&nbsp;(2021) that we should add as options:### 10.1. Parenthetical Outcome Label (Suggestion 2)The y-axis label “0 (41.94)” means: the normalized coefficient of 0 corresponds to an average outcome of 41.94 in levels. This helps readers interpret the <strong>economic magnitude</strong> of the effects.For example, if <span class="math inline">\(\hat{\beta}_3 = -0.8\)</span> and the baseline is 41.94, then the treatment reduced the outcome by approximately <span class="math inline">\(0.8/41.94 \approx 1.9\%\)</span> by period 3.### 10.2. Joint Wald Test for Pre-TrendsInstead of eyeballing whether pre-treatment coefficients are “close to zero”, run a formal joint test:<span class="math display">\[H_0: \beta_{-K} = \beta_{-K+1} = \cdots = \beta_{-2} = 0\]</span>This is an F-test (Wald test) using the joint variance-covariance matrix.<strong>diff-diff status</strong>: <code>ImputationDiD</code> already has <code>pretrend_test()</code> returning an F-stat and p-value. But it’s not available for other estimators or as a general utility.### 10.3. Leveling-Off TestTests whether the post-treatment effects are constant over time:<span class="math display">\[H_0: \beta_0 = \beta_1 = \cdots = \beta_K\]</span>If we fail to reject, we can summarize with a single average ATT. The “smoothest path” + “Constant effects p-value” in the third figure from the paper shows this.<strong>diff-diff status</strong>: Not implemented anywhere.</h2>
<div id="j6t02i9dvko" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pretrend_wald_test(estimates, vcov, pre_indices):    <span class="st">"""    Joint Wald F-test for pre-treatment coefficients = 0.        H0: beta_</span><span class="sc">{pre}</span><span class="st"> = 0 (parallel trends hold)        Parameters    ----------    estimates : array-like (K,)        All event study coefficients.    vcov : array-like (K, K)        Variance-covariance matrix.    pre_indices : array-like        Indices of pre-treatment periods (excluding reference).        Returns    -------    dict with f_stat, p_value, df_num, df_denom    """</span>    gamma <span class="op">=</span> np.array(estimates)[pre_indices]    V <span class="op">=</span> np.array(vcov)[np.ix_(pre_indices, pre_indices)]    n <span class="op">=</span> <span class="bu">len</span>(gamma)        <span class="co"># Wald statistic: gamma' V^{-1} gamma    V_inv = np.linalg.inv(V)    wald_stat = gamma @ V_inv @ gamma    f_stat = wald_stat / n        # F-distribution p-value (conservative: use n as df_denom)    # In practice, df_denom depends on clustering; here we use chi2 / n    p_value = scipy_stats.chi2.sf(wald_stat, df=n)        return {        'f_stat': f_stat,        'wald_stat': wald_stat,        'p_value': p_value,        'df': n,        'pre_coefficients': gamma,    }def leveling_off_test(estimates, vcov, post_indices):    """    Test whether post-treatment effects are constant (leveling off).        H0: beta_0 = beta_1 = ... = beta_K (all post-treatment effects equal)        Implemented as a Wald test on the contrasts:    beta_1 - beta_0 = 0, beta_2 - beta_0 = 0, ..., beta_K - beta_0 = 0        Parameters    ----------    estimates : array-like (K,)        All event study coefficients.    vcov : array-like (K, K)        Variance-covariance matrix.    post_indices : array-like        Indices of post-treatment periods.        Returns    -------    dict with f_stat, p_value, df    """    betas = np.array(estimates)[post_indices]    V_post = np.array(vcov)[np.ix_(post_indices, post_indices)]    n_post = len(betas)        if n_post &lt; 2:        return {'f_stat': np.nan, 'p_value': np.nan, 'df': 0}        # Contrast matrix R: each row tests beta_j - beta_0 = 0    # R is (n_post-1) x n_post    R = np.zeros((n_post - 1, n_post))    for j in range(n_post - 1):        R[j, 0] = -1        R[j, j + 1] = 1        # Contrasts    r = R @ betas  # should be ~0 under H0    V_r = R @ V_post @ R.T  # variance of contrasts        # Wald statistic    V_r_inv = np.linalg.inv(V_r)    wald_stat = r @ V_r_inv @ r    df = n_post - 1    p_value = scipy_stats.chi2.sf(wald_stat, df=df)        return {        'f_stat': wald_stat / df,        'wald_stat': wald_stat,        'p_value': p_value,        'df': df,        'contrasts': r,    }# Demo with our synthetic data# Use the existing es_df and vcov_full from earlierest_arr = es_df['estimate'].valuesper_arr = es_df['period'].valuespre_idx = np.where((per_arr &lt; -1))[0]  # exclude referencepost_idx = np.where(per_arr &gt;= 0)[0]pre_test = pretrend_wald_test(est_arr, vcov_full, pre_idx)lev_test = leveling_off_test(est_arr, vcov_full, post_idx)print('=== Joint Pre-Trend Test ===')print(f'  H0: all pre-treatment coefficients = 0')print(f'  Wald stat = {pre_test["wald_stat"]:.3f}, df = {pre_test["df"]}')print(f'  p-value = {pre_test["p_value"]:.4f}')print(f'  Pre-coefficients: {pre_test["pre_coefficients"].round(3)}')print()print('=== Leveling-Off Test ===')print(f'  H0: all post-treatment effects are equal')print(f'  Wald stat = {lev_test["wald_stat"]:.3f}, df = {lev_test["df"]}')print(f'  p-value = {lev_test["p_value"]:.4f}')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="prototype-freyaldenhoven-style-event-study-plotputting-it-all-together-parenthetical-outcome-label-sup-t-bands-p-values-below-the-plot-and-optional-smoothest-path-with-constant-effects-test." class="level3">
<h3 class="anchored" data-anchor-id="prototype-freyaldenhoven-style-event-study-plotputting-it-all-together-parenthetical-outcome-label-sup-t-bands-p-values-below-the-plot-and-optional-smoothest-path-with-constant-effects-test.">10.4. Prototype: Freyaldenhoven-Style Event Study PlotPutting it all together: parenthetical outcome label, sup-t bands, p-values below the plot, and optional smoothest path with constant-effects test.</h3>
<div id="6usix30ra5l" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ggiplot_freyaldenhoven(    results,    <span class="op">*</span>,    ci_level<span class="op">=</span><span class="fl">0.95</span>,    vcov<span class="op">=</span><span class="va">None</span>,    reference_period<span class="op">=</span><span class="va">None</span>,    <span class="co"># Freyaldenhoven features    baseline_outcome=None,       # average Y at reference period (for parenthetical label)    show_supt=True,              # show sup-t bands alongside pointwise    show_pretrend_pval=True,     # print pre-trend Wald test p-value    show_leveloff_pval=True,     # print leveling-off test p-value    show_smoothest_path=False,   # overlay smoothest confounding path    show_constant_fit=False,     # overlay constant effects fit (step function)    # Aesthetics    color='#006400',             # dark green (like the Freyaldenhoven plots)    figsize=(10, 6.5),    title='Event Study',    xlabel='Event time',    ylabel='Coefficient',    ax=None,    show=True,):    """    Event study plot following Freyaldenhoven et al. (2021) recommendations.        Features:    - Parenthetical outcome level label on y-axis: "0 (41.94)"    - Pointwise CIs + sup-t simultaneous bands    - Pre-trend Wald test p-value below the plot    - Leveling-off test p-value below the plot    - Optional smoothest confounding path overlay    - Optional constant-effects step function overlay    """    if ax is None:        fig, ax = plt.subplots(figsize=figsize)    else:        fig = ax.get_figure()        # Extract data    if isinstance(results, pd.DataFrame):        df = results.copy()        if 'effect' in df.columns:            df = df.rename(columns={'effect': 'estimate'})        periods = df['period'].values        estimates = df['estimate'].values        se_vals = df['se'].values    else:        raise TypeError('Pass a DataFrame with period, estimate, se columns')        ref = reference_period if reference_period is not None else -1    z_pw = scipy_stats.norm.ppf(1 - (1 - ci_level) / 2)        pre_mask = periods &lt; ref    post_mask = periods &gt;= 0    pre_idx = np.where(pre_mask)[0]    post_idx = np.where(post_mask)[0]        # --- Pointwise CIs (thinner, inner) ---    ci_pw_low = estimates - z_pw * se_vals    ci_pw_high = estimates + z_pw * se_vals        ax.errorbar(periods, estimates, yerr=[estimates - ci_pw_low, ci_pw_high - estimates],                fmt='o', color=color, capsize=3, markersize=7, linewidth=1.2,                capthick=1.0, zorder=3, label=f'{ci_level:.0%} Pointwise CI')        # --- Sup-t bands (wider, outer) ---    if show_supt and vcov is not None:        c_supt = compute_supt_critical_value(vcov, alpha=1-ci_level)        ci_supt_low = estimates - c_supt * se_vals        ci_supt_high = estimates + c_supt * se_vals                # Draw sup-t as wider caps (like the Freyaldenhoven paper style)        for i, p in enumerate(periods):            ax.plot([p, p], [ci_supt_low[i], ci_supt_high[i]],                    color='gray', linewidth=0.8, zorder=2)            ax.plot([p - 0.15, p + 0.15], [ci_supt_low[i], ci_supt_low[i]],                    color='gray', linewidth=0.8, zorder=2)            ax.plot([p - 0.15, p + 0.15], [ci_supt_high[i], ci_supt_high[i]],                    color='gray', linewidth=0.8, zorder=2)        # Invisible line for legend        ax.plot([], [], color='gray', linewidth=0.8, label=f'{ci_level:.0%} Sup-t band')        # --- Smoothest confounding path ---    if show_smoothest_path:        pre_est_mask = (periods &lt; ref) &amp; (periods != ref)        if pre_est_mask.sum() &gt;= 2:            sp_periods, sp_path = compute_smoothest_path(                estimates[pre_est_mask], periods[pre_est_mask],                periods[post_mask], ref_period=ref            )            ax.plot(sp_periods, sp_path, '-', color='#003366', linewidth=3,                    alpha=0.8, label='Smoothest path', zorder=4)        # --- Constant effects fit (step function) ---    if show_constant_fit and post_mask.any():        mean_post = estimates[post_mask].mean()        # Step function: 0 for pre, mean_post for post        ax.plot([periods[pre_mask].min() - 0.5, ref + 0.5], [0, 0],                '-', color='#003366', linewidth=3, alpha=0.8, zorder=4)        ax.plot([ref + 0.5, ref + 0.5], [0, mean_post],                '-', color='#003366', linewidth=3, alpha=0.8, zorder=4)        ax.plot([ref + 0.5, periods[post_mask].max() + 0.5], [mean_post, mean_post],                '-', color='#003366', linewidth=3, alpha=0.8,                label=f'Constant effect = {mean_post:.2f}', zorder=4)        # --- Reference lines ---    ax.axhline(0, color='#006400', linestyle='--', linewidth=1.2, alpha=0.6)        # --- Parenthetical outcome label ---    if baseline_outcome is not None:        ax.set_ylabel(ylabel, fontsize=11)        # Add the baseline label at y=0        ax.annotate(f'0 ({baseline_outcome:.2f})',                    xy=(periods.min() - 1.2, 0),                    fontsize=9, color='#006400', ha='right', va='center')    else:        ax.set_ylabel(ylabel, fontsize=11)        # --- P-values below the plot ---    pval_texts = []    if show_pretrend_pval and vcov is not None and len(pre_idx) &gt;= 2:        pt = pretrend_wald_test(estimates, vcov, pre_idx)        pval_texts.append(f'Pretrends p-value = {pt["p_value"]:.2f}')        if show_leveloff_pval and vcov is not None and len(post_idx) &gt;= 2:        lt = leveling_off_test(estimates, vcov, post_idx)        pval_texts.append(f'Leveling off p-value = {lt["p_value"]:.2f}')        if show_constant_fit and vcov is not None and len(post_idx) &gt;= 2:        ct = leveling_off_test(estimates, vcov, post_idx)        # Replace leveling off with constant effects label        pval_texts = [t for t in pval_texts if 'Leveling' not in t]        pval_texts.append(f'Constant effects p-value = {ct["p_value"]:.2f}')        if pval_texts:        pval_str = '  --  '.join(pval_texts)        ax.text(0.5, -0.12, pval_str, transform=ax.transAxes,                fontsize=9, ha='center', va='top', style='italic')        ax.set_title(title, fontsize=13)    ax.set_xlabel(xlabel, fontsize=11)    ax.legend(fontsize=9, loc='best')    ax.grid(True, alpha=0.15)        if show:        plt.tight_layout()        plt.show()        return axprint('ggiplot_freyaldenhoven() defined')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="vze6rgrh8mj" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo 1: "Smooth" event-time trend (like Figure (a) in the paper)# Pointwise + sup-t bands, with p-values belowggiplot_freyaldenhoven(    es_df,    vcov=vcov_full,    reference_period=-1,    baseline_outcome=41.94,    show_supt=True,    show_pretrend_pval=True,    show_leveloff_pval=True,    title='"Smooth" event-time trend (Freyaldenhoven style)',)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="q99hjapw13" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo 2: With smoothest path + constant effects step function# (like the third figure from the paper)ggiplot_freyaldenhoven(    es_df,    vcov=vcov_full,    reference_period=-1,    baseline_outcome=5.12,    show_supt=True,    show_smoothest_path=True,    show_constant_fit=True,    show_pretrend_pval=False,    show_leveloff_pval=False,    title='Smoothest path + Constant effects fit (Freyaldenhoven style)',)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="nml0i191b4" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demo 3: Side by side — all three Freyaldenhoven figure stylesfig, axes = plt.subplots(1, 3, figsize=(20, 6), sharey=True)# (a) Smooth event-time trend: pointwise + sup-tggiplot_freyaldenhoven(    es_df, vcov=vcov_full, reference_period=-1,    baseline_outcome=41.94,    show_supt=True, show_pretrend_pval=True, show_leveloff_pval=True,    title='(a) Pointwise + Sup-t\n+ p-values',    ax=axes[0], show=False,)# (b) Jump at event: same but different datanp.random.seed(99)jump_est = np.where(es_df['period'] &gt;= 0, 0.5, 0) + np.random.normal(0, 0.15, len(es_df))jump_est[es_df['period'].values == -1] = 0.0jump_df = es_df.copy()jump_df['estimate'] = jump_estggiplot_freyaldenhoven(    jump_df, vcov=vcov_full, reference_period=-1,    baseline_outcome=41.94,    show_supt=True, show_pretrend_pval=True, show_leveloff_pval=True,    title='(b) "Jump" at event\n+ p-values',    ax=axes[1], show=False,)# (c) Smoothest path + constant effectsggiplot_freyaldenhoven(    jump_df, vcov=vcov_full, reference_period=-1,    baseline_outcome=5.12,    show_supt=True, show_smoothest_path=True, show_constant_fit=True,    show_pretrend_pval=False, show_leveloff_pval=False,    title='(c) Smoothest path\n+ constant effects fit',    ax=axes[2], show=False,)plt.tight_layout()plt.subplots_adjust(bottom=0.15)plt.show()print('These replicate the three figure styles from Freyaldenhoven et al. (2021).')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="what-diff-diff-already-has-vs.-what-we-need-feature-diff-diff-status-our-contribution-parenthetical-outcome-label-not-available-baseline_outcome-param-in-ggiplot-pre-trend-wald-test-only-in-imputationdid.pretrend_test-generalize-to-pretrend_wald_test-for-any-estimator-leveling-off-test-not-available-leveling_off_test-new-constant-effects-p-value-not-available-leveling_off_test-step-function-overlay-sup-t-bands-on-same-plot-not-available-show_supttrue-outer-bands-in-gray-smoothest-path-overlay-not-available-show_smoothest_pathtrue-vcv-matrix-stored-in-multiperioddidresults.vcov-already-available-for-real-results-key-design-choice-the-freyaldenhoven-style-features-should-be-composable-options-in-our-ggiplot-not-a-separate-function.-the-ggiplot_freyaldenhoven-above-is-a-prototype-in-the-final-version-these-would-be-parameters-of-the-unified-ggiplot." class="level3">
<h3 class="anchored" data-anchor-id="what-diff-diff-already-has-vs.-what-we-need-feature-diff-diff-status-our-contribution-parenthetical-outcome-label-not-available-baseline_outcome-param-in-ggiplot-pre-trend-wald-test-only-in-imputationdid.pretrend_test-generalize-to-pretrend_wald_test-for-any-estimator-leveling-off-test-not-available-leveling_off_test-new-constant-effects-p-value-not-available-leveling_off_test-step-function-overlay-sup-t-bands-on-same-plot-not-available-show_supttrue-outer-bands-in-gray-smoothest-path-overlay-not-available-show_smoothest_pathtrue-vcv-matrix-stored-in-multiperioddidresults.vcov-already-available-for-real-results-key-design-choice-the-freyaldenhoven-style-features-should-be-composable-options-in-our-ggiplot-not-a-separate-function.-the-ggiplot_freyaldenhoven-above-is-a-prototype-in-the-final-version-these-would-be-parameters-of-the-unified-ggiplot.">10.5. What diff-diff Already Has vs.&nbsp;What We Need| Feature | diff-diff status | Our contribution ||———|—————–|——————|| <strong>Parenthetical outcome label</strong> | Not available | <code>baseline_outcome</code> param in <code>ggiplot()</code> || <strong>Pre-trend Wald test</strong> | Only in <code>ImputationDiD.pretrend_test()</code> | Generalize to <code>pretrend_wald_test()</code> for any estimator || <strong>Leveling-off test</strong> | Not available | <code>leveling_off_test()</code> — new || <strong>Constant effects p-value</strong> | Not available | <code>leveling_off_test()</code> + step function overlay || <strong>Sup-t bands on same plot</strong> | Not available | <code>show_supt=True</code> — outer bands in gray || <strong>Smoothest path overlay</strong> | Not available | <code>show_smoothest_path=True</code> || <strong>VCV matrix</strong> | Stored in <code>MultiPeriodDiDResults.vcov</code> | Already available for real results |<strong>Key design choice</strong>: The Freyaldenhoven-style features should be composable options in our <code>ggiplot()</code>, not a separate function. The <code>ggiplot_freyaldenhoven()</code> above is a prototype — in the final version, these would be parameters of the unified <code>ggiplot()</code>.</h3>
</section>
</section>
<section id="comprehensive-roadmap-contribution-architecturethe-contribution-to-diff-diff-spans-four-domains-a-plotting-improvements-b-honest-inference-c-multi-model-fairness-and-d-freyaldenhoven-best-practices.diff-diff-contribution---a.-plotting-from-plotting_exploration-notebook----iplot_data-ggiplot----geom_style-ci_level-multi-model-aggr_eff---b.-honest-inference-this-notebook-sections-3-8----sup-t-simultaneous-bands----smoothest-confounding-path----functional-scbs-fdid----integration-with-existing-honestdid---c.-multi-model-fairness-section-9-novel----get_estimator_metadata----check_multi_model_comparability----auto-annotation-annotateauto----kink-artifact-demo---d.-freyaldenhoven-best-practices-section-10----parenthetical-outcome-label-baseline_outcome----joint-pre-trend-wald-test-generalized----leveling-off-test-new----constant-effects-step-function-overlay----sup-t-bands-alongside-pointwise-implementation-priority-updated-priority-feature-source-difficulty-impact---1-iplot_data-with-ci_type-all-low-high-2-ggiplot-with-geom_style-ggfixest-medium-high-3-sup-t-simultaneous-bands-eventstudyr-low-high-4-multi-model-comparability-check-roth-2026-low-high-5-auto-annotation-for-multi-model-novel-medium-high-6-generalized-pre-trend-wald-test-freyaldenhoven-low-high-7-leveling-off-test-freyaldenhoven-low-medium-8-parenthetical-outcome-label-freyaldenhoven-low-medium-9-smoothest-confounding-path-eventstudyr-medium-medium-10-constant-effects-step-function-freyaldenhoven-low-medium-11-functional-scbs-infsup-fdid-medium-high-12-equivalence-region-overlay-fdid-low-medium-13-multi-model-comparison-dodgefacet-ggfixest-medium-high-14-aggregate-effects-overlay-ggfixest-low-medium-15-honestdid-integration-diff-diff-medium-medium-16-roth-2026-kink-artifact-demo-paper-low-medium-vcov-requirements-feature-needs-vcov-diff-diff-status---pointwise-cis-no-se-only-default-sup-t-bands-yes-multiperioddidresults.vcov-available-fdid-scbs-yes-same-pre-trend-wald-test-yes-available-interaction_indices-leveling-off-test-yes-available-smoothest-path-no-uses-point-estimates-only-honestdid-sensitivity-no-uses-se-already-supported-multi-model-check-no-uses-result-object-metadata-file-structure-for-prdiff_diff-plotting-__init__.py-iplot_data.py-tidy-data-extraction-ci_type-ggiplot.py-enhanced-event-study-plot-unified-honest_bands.py-sup-t-scbs-smoothest-path-multi_model.py-comparability-check-annotation-tests_on_plot.py-wald-tests-leveling-off-p-values-utils.py-shared-utilities-tests-test_iplot_data.py-test_ggiplot.py-test_honest_bands.py-test_multi_model.py-test_tests_on_plot.py" class="level2">
<h2 class="anchored" data-anchor-id="comprehensive-roadmap-contribution-architecturethe-contribution-to-diff-diff-spans-four-domains-a-plotting-improvements-b-honest-inference-c-multi-model-fairness-and-d-freyaldenhoven-best-practices.diff-diff-contribution---a.-plotting-from-plotting_exploration-notebook----iplot_data-ggiplot----geom_style-ci_level-multi-model-aggr_eff---b.-honest-inference-this-notebook-sections-3-8----sup-t-simultaneous-bands----smoothest-confounding-path----functional-scbs-fdid----integration-with-existing-honestdid---c.-multi-model-fairness-section-9-novel----get_estimator_metadata----check_multi_model_comparability----auto-annotation-annotateauto----kink-artifact-demo---d.-freyaldenhoven-best-practices-section-10----parenthetical-outcome-label-baseline_outcome----joint-pre-trend-wald-test-generalized----leveling-off-test-new----constant-effects-step-function-overlay----sup-t-bands-alongside-pointwise-implementation-priority-updated-priority-feature-source-difficulty-impact---1-iplot_data-with-ci_type-all-low-high-2-ggiplot-with-geom_style-ggfixest-medium-high-3-sup-t-simultaneous-bands-eventstudyr-low-high-4-multi-model-comparability-check-roth-2026-low-high-5-auto-annotation-for-multi-model-novel-medium-high-6-generalized-pre-trend-wald-test-freyaldenhoven-low-high-7-leveling-off-test-freyaldenhoven-low-medium-8-parenthetical-outcome-label-freyaldenhoven-low-medium-9-smoothest-confounding-path-eventstudyr-medium-medium-10-constant-effects-step-function-freyaldenhoven-low-medium-11-functional-scbs-infsup-fdid-medium-high-12-equivalence-region-overlay-fdid-low-medium-13-multi-model-comparison-dodgefacet-ggfixest-medium-high-14-aggregate-effects-overlay-ggfixest-low-medium-15-honestdid-integration-diff-diff-medium-medium-16-roth-2026-kink-artifact-demo-paper-low-medium-vcov-requirements-feature-needs-vcov-diff-diff-status---pointwise-cis-no-se-only-default-sup-t-bands-yes-multiperioddidresults.vcov-available-fdid-scbs-yes-same-pre-trend-wald-test-yes-available-interaction_indices-leveling-off-test-yes-available-smoothest-path-no-uses-point-estimates-only-honestdid-sensitivity-no-uses-se-already-supported-multi-model-check-no-uses-result-object-metadata-file-structure-for-prdiff_diff-plotting-__init__.py-iplot_data.py-tidy-data-extraction-ci_type-ggiplot.py-enhanced-event-study-plot-unified-honest_bands.py-sup-t-scbs-smoothest-path-multi_model.py-comparability-check-annotation-tests_on_plot.py-wald-tests-leveling-off-p-values-utils.py-shared-utilities-tests-test_iplot_data.py-test_ggiplot.py-test_honest_bands.py-test_multi_model.py-test_tests_on_plot.py">11. Comprehensive Roadmap### Contribution ArchitectureThe contribution to <code>diff-diff</code> spans <strong>four domains</strong>: (A) plotting improvements, (B) honest inference, (C) multi-model fairness, and (D) Freyaldenhoven best practices.<code>diff-diff contribution|+-- A. PLOTTING (from plotting_exploration notebook)|   +-- iplot_data(), ggiplot()|   +-- geom_style, ci_level, multi-model, aggr_eff|+-- B. HONEST INFERENCE (this notebook, sections 3-8)|   +-- Sup-t simultaneous bands|   +-- Smoothest confounding path|   +-- Functional SCBs (fdid)|   +-- Integration with existing HonestDiD|+-- C. MULTI-MODEL FAIRNESS (section 9)  *** NOVEL ***|   +-- get_estimator_metadata()|   +-- check_multi_model_comparability()|   +-- Auto-annotation (annotate='auto')|   +-- Kink artifact demo|+-- D. FREYALDENHOVEN BEST PRACTICES (section 10)    +-- Parenthetical outcome label (baseline_outcome)    +-- Joint pre-trend Wald test (generalized)    +-- Leveling-off test (new)    +-- Constant effects step function overlay    +-- Sup-t bands alongside pointwise</code>### Implementation Priority (Updated)| Priority | Feature | Source | Difficulty | Impact ||———-|———|——–|————|——–|| 1 | <code>iplot_data()</code> with <code>ci_type</code> | All | Low | HIGH || 2 | <code>ggiplot()</code> with <code>geom_style</code> | ggfixest | Medium | HIGH || 3 | Sup-t simultaneous bands | eventstudyr | Low | HIGH || 4 | <strong>Multi-model comparability check</strong> | <strong>Roth (2026)</strong> | <strong>Low</strong> | <strong>HIGH</strong> || 5 | <strong>Auto-annotation for multi-model</strong> | <strong>Novel</strong> | <strong>Medium</strong> | <strong>HIGH</strong> || 6 | <strong>Generalized pre-trend Wald test</strong> | <strong>Freyaldenhoven</strong> | <strong>Low</strong> | <strong>HIGH</strong> || 7 | <strong>Leveling-off test</strong> | <strong>Freyaldenhoven</strong> | <strong>Low</strong> | <strong>MEDIUM</strong> || 8 | <strong>Parenthetical outcome label</strong> | <strong>Freyaldenhoven</strong> | <strong>Low</strong> | <strong>MEDIUM</strong> || 9 | Smoothest confounding path | eventstudyr | Medium | MEDIUM || 10 | <strong>Constant effects step function</strong> | <strong>Freyaldenhoven</strong> | <strong>Low</strong> | <strong>MEDIUM</strong> || 11 | Functional SCBs (inf/sup) | fdid | Medium | HIGH || 12 | Equivalence region overlay | fdid | Low | MEDIUM || 13 | Multi-model comparison (dodge/facet) | ggfixest | Medium | HIGH || 14 | Aggregate effects overlay | ggfixest | Low | MEDIUM || 15 | HonestDiD integration | diff-diff | Medium | MEDIUM || 16 | Roth (2026) kink artifact demo | Paper | Low | MEDIUM |### vcov Requirements| Feature | Needs vcov? | diff-diff status ||———|————-|——————|| Pointwise CIs | No (SE only) | Default || Sup-t bands | <strong>Yes</strong> | <code>MultiPeriodDiDResults.vcov</code> available || fdid SCBs | <strong>Yes</strong> | Same || Pre-trend Wald test | <strong>Yes</strong> | Available + <code>interaction_indices</code> || Leveling-off test | <strong>Yes</strong> | Available || Smoothest path | No | Uses point estimates only || HonestDiD sensitivity | No (uses SE) | Already supported || Multi-model check | No | Uses result object metadata |### File Structure for PR<code>diff_diff/  plotting/    __init__.py    iplot_data.py          # Tidy data extraction + ci_type    ggiplot.py             # Enhanced event study plot (unified)    honest_bands.py        # Sup-t, SCBs, smoothest path    multi_model.py         # Comparability check + annotation    tests_on_plot.py       # Wald tests, leveling-off, p-values    utils.py               # Shared utilities  tests/    test_iplot_data.py    test_ggiplot.py    test_honest_bands.py    test_multi_model.py    test_tests_on_plot.py</code></h2>
</section>
<section id="summary-what-we-prototyped-16-features-across-4-domainsa.-plotting-from-previous-notebook--iplot_data-ggiplot-with-ribbonerrorbarpointrange-nested-cis-multi-model-aggregate-effectsb.-honest-inference1.-compute_supt_critical_value-simulation-based-sup-t-critical-values2.-compute_scb_critical_values-infimum-supremum-scbs-fdid3.-compute_smoothest_path-minimum-curvature-confounding-path4.-enhanced-iplot_data-with-ci_typepointwisesup-tfdid5.-enhanced-ggiplot-with-composable-honest-inference-layersc.-multi-model-fairness-novel6.-get_estimator_metadata-introspects-reference-period-construction-type-symmetry7.-check_multi_model_comparability-detects-mismatches-warns-automatically8.-ggiplot_multi_annotated-auto-annotated-multi-model-plots9.-roth-2026-kink-artifact-visual-demo10.-long-vs.-short-difference-definitions-concrete-numerical-exampled.-freyaldenhoven-best-practices11.-pretrend_wald_test-generalized-joint-pre-trend-f-test-diff-diff-only-has-it-for-imputation12.-leveling_off_test-post-treatment-constant-effects-wald-test-new13.-baseline_outcome-parenthetical-outcome-level-label-on-y-axis14.-constant-effects-step-function-overlay15.-sup-t-bands-drawn-alongside-pointwise-cis-outer-gray-bars16.-ggiplot_freyaldenhoven-replicates-all-three-figure-styles-from-the-paper-whats-genuinely-novel-no-r-or-python-package-does-this-feature-why-novel-multi-model-comparability-check-no-tool-warns-about-reference-period-construction-differences-auto-annotation-no-tool-annotates-which-base-period-each-estimator-uses-generalized-pre-trend-test-diff-diff-only-has-it-for-imputation-not-general-leveling-off-test-not-implemented-anywhere-in-diff-diff-composable-honest-inference-layers-no-python-package-combines-sup-t-smoothest-path-fdid-scbs-in-one-function-next-steps1.-run-this-notebook-end-to-end-to-verify-all-prototypes-work2.-check-if-diff-diff-exposes-vcov-from-callawaysantanna-and-sunabraham-not-just-multiperioddid3.-write-unit-tests-for-all-new-functions4.-integrate-all-features-into-one-unified-ggiplot-function5.-package-as-a-clean-pr-to-diff-diff" class="level2">
<h2 class="anchored" data-anchor-id="summary-what-we-prototyped-16-features-across-4-domainsa.-plotting-from-previous-notebook--iplot_data-ggiplot-with-ribbonerrorbarpointrange-nested-cis-multi-model-aggregate-effectsb.-honest-inference1.-compute_supt_critical_value-simulation-based-sup-t-critical-values2.-compute_scb_critical_values-infimum-supremum-scbs-fdid3.-compute_smoothest_path-minimum-curvature-confounding-path4.-enhanced-iplot_data-with-ci_typepointwisesup-tfdid5.-enhanced-ggiplot-with-composable-honest-inference-layersc.-multi-model-fairness-novel6.-get_estimator_metadata-introspects-reference-period-construction-type-symmetry7.-check_multi_model_comparability-detects-mismatches-warns-automatically8.-ggiplot_multi_annotated-auto-annotated-multi-model-plots9.-roth-2026-kink-artifact-visual-demo10.-long-vs.-short-difference-definitions-concrete-numerical-exampled.-freyaldenhoven-best-practices11.-pretrend_wald_test-generalized-joint-pre-trend-f-test-diff-diff-only-has-it-for-imputation12.-leveling_off_test-post-treatment-constant-effects-wald-test-new13.-baseline_outcome-parenthetical-outcome-level-label-on-y-axis14.-constant-effects-step-function-overlay15.-sup-t-bands-drawn-alongside-pointwise-cis-outer-gray-bars16.-ggiplot_freyaldenhoven-replicates-all-three-figure-styles-from-the-paper-whats-genuinely-novel-no-r-or-python-package-does-this-feature-why-novel-multi-model-comparability-check-no-tool-warns-about-reference-period-construction-differences-auto-annotation-no-tool-annotates-which-base-period-each-estimator-uses-generalized-pre-trend-test-diff-diff-only-has-it-for-imputation-not-general-leveling-off-test-not-implemented-anywhere-in-diff-diff-composable-honest-inference-layers-no-python-package-combines-sup-t-smoothest-path-fdid-scbs-in-one-function-next-steps1.-run-this-notebook-end-to-end-to-verify-all-prototypes-work2.-check-if-diff-diff-exposes-vcov-from-callawaysantanna-and-sunabraham-not-just-multiperioddid3.-write-unit-tests-for-all-new-functions4.-integrate-all-features-into-one-unified-ggiplot-function5.-package-as-a-clean-pr-to-diff-diff">Summary### What We Prototyped (16 features across 4 domains)<strong>A. Plotting (from previous notebook):</strong>- <code>iplot_data()</code>, <code>ggiplot()</code> with ribbon/errorbar/pointrange, nested CIs, multi-model, aggregate effects<strong>B. Honest Inference:</strong>1. <code>compute_supt_critical_value()</code> – simulation-based sup-t critical values2. <code>compute_scb_critical_values()</code> – infimum + supremum SCBs (fdid)3. <code>compute_smoothest_path()</code> – minimum curvature confounding path4. Enhanced <code>iplot_data()</code> with <code>ci_type='pointwise'|'sup-t'|'fdid'</code>5. Enhanced <code>ggiplot()</code> with composable honest inference layers<strong>C. Multi-Model Fairness (Novel):</strong>6. <code>get_estimator_metadata()</code> – introspects reference period, construction type, symmetry7. <code>check_multi_model_comparability()</code> – detects mismatches, warns automatically8. <code>ggiplot_multi_annotated()</code> – auto-annotated multi-model plots9. Roth (2026) kink artifact visual demo10. Long vs.&nbsp;short difference definitions + concrete numerical example<strong>D. Freyaldenhoven Best Practices:</strong>11. <code>pretrend_wald_test()</code> – generalized joint pre-trend F-test (diff-diff only has it for Imputation)12. <code>leveling_off_test()</code> – post-treatment constant effects Wald test (new)13. <code>baseline_outcome</code> – parenthetical outcome level label on y-axis14. Constant effects step function overlay15. Sup-t bands drawn alongside pointwise CIs (outer gray bars)16. <code>ggiplot_freyaldenhoven()</code> – replicates all three figure styles from the paper### What’s Genuinely Novel (no R or Python package does this)| Feature | Why novel ||———|———–|| Multi-model comparability check | No tool warns about reference period / construction differences || Auto-annotation | No tool annotates which base period each estimator uses || Generalized pre-trend test | diff-diff only has it for Imputation, not general || Leveling-off test | Not implemented anywhere in diff-diff || Composable honest inference layers | No Python package combines sup-t + smoothest path + fdid SCBs in one function |### Next Steps1. Run this notebook end-to-end to verify all prototypes work2. Check if <code>diff-diff</code> exposes vcov from CallawaySantAnna and SunAbraham (not just MultiPeriodDiD)3. Write unit tests for all new functions4. Integrate all features into one unified <code>ggiplot()</code> function5. Package as a clean PR to <code>diff-diff</code></h2>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dannyredel\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>© 2026 Daniel Redel</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>